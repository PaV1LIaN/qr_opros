<?php
if (!defined("B_PROLOG_INCLUDED") || B_PROLOG_INCLUDED !== true) die();
global $USER;

use Bitrix\Main\UI\Extension;

Extension::load(['ui.entity-selector', 'ui.buttons', 'ui.alerts', 'main.core']);
?>

<style>
.portal-card {
    background: #fff;
    border: 1px solid #e3e7ec;
    border-radius: 12px;
    padding: 18px;
    margin-bottom: 16px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    transition: all 0.2s ease;
}
.portal-card:hover {
    box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    border-color: #dce2eb;
}
.portal-card h4 {
    margin: 0;
    font-size: 17px;
    font-weight: 600;
}
.portal-meta {
    color: #9ea5b4;
    font-size: 13px;
    margin-top: 4px;
}
.portal-users {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
}
.portal-list-link {
    text-decoration: none;
    color: #0065ff;
    display: block;
    padding: 12px 16px;
    background: #fff;
    border-radius: 8px;
    margin-bottom: 8px;
    transition: background 0.2s;
}
.portal-list-link:hover {
    background: #f5f7fa;
}
</style>

<div style="margin:24px 0;">
    <h3 style="margin:0 0 16px; font-size:20px; font-weight:600;">Доступные сайты</h3>

    <?php if (empty($sites)): ?>
        <div class="ui-alert ui-alert-warning">
            <span class="ui-alert-message">Нет доступных сайтов.</span>
        </div>
    <?php else: ?>

        <?php if (!$USER->IsAdmin()): ?>
            <!-- ======= ВИД ДЛЯ ОБЫЧНОГО ПОЛЬЗОВАТЕЛЯ ======= -->
            <?php foreach ($sites as $site): ?>
                <?php
                $siteName = htmlspecialcharsbx($site["NAME"]);
                $siteCode = htmlspecialcharsbx($site["CODE"]);
                ?>
                <a href="/local/portal_hub/sites/<?= $siteCode ?>/" class="portal-list-link">
                    <?= $siteName ?>
                </a>
            <?php endforeach; ?>

        <?php else: ?>
            <!-- ======= ВИД ДЛЯ АДМИНИСТРАТОРОВ ======= -->
            <?php foreach ($sites as $site): ?>
                <?php
                $siteId   = (int)$site["ID"];
                $siteName = htmlspecialcharsbx($site["NAME"]);
                $siteCode = htmlspecialcharsbx($site["CODE"]);
                $roleAdminId = (int)($site["PROPERTY_SITE_ROLE_VALUE"] ?? 0);
                $roleUserId  = (int)($site["PROPERTY_SITE_USER_ROLE_VALUE"] ?? 0);

                // Получаем текущих участников ролей
                $getMembers = function($roleId) {
                    $members = [];
                    if ($roleId > 0) {
                        $by = "id"; $order = "asc";
                        $rs = \CUser::GetList($by, $order, ["GROUPS_ID" => [$roleId]], ["FIELDS" => ["ID","NAME","LAST_NAME","LOGIN","PERSONAL_PHOTO"]]);
                        while ($u = $rs->Fetch()) {
                            $name = trim($u["NAME"] . " " . $u["LAST_NAME"]);
                            if ($name === "") { $name = $u["LOGIN"]; }

                            $photo = "";
                            if (!empty($u["PERSONAL_PHOTO"])) {
                                $file = \CFile::ResizeImageGet($u["PERSONAL_PHOTO"], ["width"=>32,"height"=>32], BX_RESIZE_IMAGE_EXACT, false);
                                if (!empty($file["src"])) {
                                    $photo = $file["src"];
                                }
                            }

                            $members[] = [
                                "id" => (int)$u["ID"],
                                "title" => $name,
                                "avatar" => $photo
                            ];
                        }
                    }
                    return $members;
                };

                $adminMembers = $getMembers($roleAdminId);
                $userMembers  = $getMembers($roleUserId);
                ?>
                <div class="portal-card">
                    <h4>
                        <a href="/local/portal_hub/sites/<?= $siteCode ?>/"
                           target="_blank"
                           class="ui-link ui-link-primary">
                           <?= $siteName ?>
                        </a>
                    </h4>

                    <div class="portal-meta">Папка: /local/portal_hub/sites/<?= $siteCode ?>/</div>
                    <div class="portal-meta">Админ. группа: <?= $roleAdminId ?: '—' ?> / Польз. группа: <?= $roleUserId ?: '—' ?></div>

                    <?php if ($roleAdminId > 0): ?>
                        <div class="portal-meta" style="margin-top:10px;"><b>Администраторы</b></div>
                        <div class="portal-users" id="user-selector-admin-<?= $roleAdminId ?>"></div>
                        <button type="button"
                            class="ui-btn ui-btn-light-border ui-btn-sm js-edit-role"
                            data-role-id="<?= $roleAdminId ?>"
                            data-users='<?= htmlspecialcharsbx(json_encode($adminMembers, JSON_UNESCAPED_UNICODE)) ?>'>
                            Редактировать администраторов
                        </button>
                        <div id="save-status-<?= $roleAdminId ?>" style="margin-top:8px;"></div>
                    <?php endif; ?>

                    <?php if ($roleUserId > 0): ?>
                        <div class="portal-meta" style="margin-top:16px;"><b>Пользователи</b></div>
                        <div class="portal-users" id="user-selector-user-<?= $roleUserId ?>"></div>
                        <button type="button"
                            class="ui-btn ui-btn-light-border ui-btn-sm js-edit-user-role"
                            data-role-id="<?= $roleUserId ?>"
                            data-users='<?= htmlspecialcharsbx(json_encode($userMembers, JSON_UNESCAPED_UNICODE)) ?>'>
                            Редактировать пользователей
                        </button>
                        <div id="save-status-<?= $roleUserId ?>" style="margin-top:8px;"></div>
                    <?php endif; ?>
                </div>

                <script>
                BX.ready(function() {
                    function renderUsers(containerId, users) {
                        const ctn = document.getElementById(containerId);
                        if (!ctn) return;
                        ctn.innerHTML = '';
                        users.forEach(u => {
                            const el = document.createElement('div');
                            el.className = 'ui-label ui-label-light ui-label-fill-light';
                            el.style.display = 'flex';
                            el.style.alignItems = 'center';
                            el.style.gap = '6px';
                            el.innerHTML =
                                (u.avatar
                                    ? '<img src="' + BX.util.htmlspecialchars(u.avatar) + '" style="width:24px; height:24px; border-radius:50%; object-fit:cover;">'
                                    : '<div style="width:24px; height:24px; border-radius:50%; background:#e1e5eb; display:flex; align-items:center; justify-content:center; font-size:11px; color:#555;">' + (u.title ? u.title.charAt(0).toUpperCase() : '?') + '</div>'
                                ) +
                                '<span class="ui-label-inner">' + BX.util.htmlspecialchars(u.title) + '</span>';
                            ctn.appendChild(el);
                        });
                    }

                    renderUsers('user-selector-admin-<?= $roleAdminId ?>', <?= \Bitrix\Main\Web\Json::encode($adminMembers) ?>);
                    renderUsers('user-selector-user-<?= $roleUserId ?>', <?= \Bitrix\Main\Web\Json::encode($userMembers) ?>);
                });
                </script>
            <?php endforeach; ?>
        <?php endif; ?>
    <?php endif; ?>
</div>

<?php if ($USER->IsAdmin()): ?>
<script>
BX.ready(function () {
    const BX_SESSID = '<?= bitrix_sessid() ?>';

    function saveRole(roleId, userIds, onDone) {
        const fd = new FormData();
        fd.append('AJAX', 'UPDATE_ROLE');
        fd.append('sessid', BX_SESSID);
        fd.append('ROLE_ID', roleId);
        userIds.forEach(id => fd.append('ROLE_USERS[]', id));

        fetch(location.href, { method: 'POST', body: fd, credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => onDone && onDone(data))
            .catch(() => onDone && onDone({ status: 'error' }));
    }

    function openSelector(btn, containerId) {
        const roleId = btn.dataset.roleId;
        const container = document.getElementById(containerId);
        const saveStatus = document.getElementById('save-status-' + roleId);
        let currentUsers = [];
        try { currentUsers = JSON.parse(btn.dataset.users) || []; } catch(e) {}

        const dialog = new BX.UI.EntitySelector.Dialog({
            id: 'portal-hub-role-' + roleId,
            context: 'PORTAL_HUB_ROLE_EDIT',
            targetNode: btn,
            entities: [{ id: 'user' }],
            multiple: true,
            enableSearch: true,
            width: 500,
            dropdownMode: false,
            selectedItems: currentUsers.map(u => ({ entityId: 'user', id: String(u.id) }))
        });

        dialog.subscribe('onHide', () => {
            const items = dialog.getSelectedItems();
            const ids = items.map(i => i.id);
            saveStatus.innerHTML = '<div class="ui-alert ui-alert-primary"><span class="ui-alert-message">Сохраняем...</span></div>';
            saveRole(roleId, ids, data => {
                if (data.status === 'success') {
                    saveStatus.innerHTML = '<div class="ui-alert ui-alert-success"><span class="ui-alert-message">Изменения сохранены.</span></div>';
                    setTimeout(() => saveStatus.innerHTML = '', 2500);
                } else {
                    saveStatus.innerHTML = '<div class="ui-alert ui-alert-danger"><span class="ui-alert-message">Ошибка при сохранении.</span></div>';
                }
            });
        });

        dialog.show();
    }

    document.querySelectorAll('.js-edit-role').forEach(btn => {
        btn.addEventListener('click', () => openSelector(btn, 'user-selector-admin-' + btn.dataset.roleId));
    });

    document.querySelectorAll('.js-edit-user-role').forEach(btn => {
        btn.addEventListener('click', () => openSelector(btn, 'user-selector-user-' + btn.dataset.roleId));
    });
});
</script>
<?php endif; ?>
