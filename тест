<?php if ($USER->IsAdmin()): ?>
<script>
BX.ready(function () {
    const BX_SESSID = '<?= bitrix_sessid() ?>';

    function saveRole(roleId, userIds, onDone) {
        const fd = new FormData();
        fd.append('AJAX', 'UPDATE_ROLE');
        fd.append('sessid', BX_SESSID);
        fd.append('ROLE_ID', roleId);
        userIds.forEach(id => fd.append('ROLE_USERS[]', id));

        fetch(location.href, { method: 'POST', body: fd, credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => onDone && onDone(data))
            .catch(() => onDone && onDone({ status: 'error' }));
    }

    function openSelector(btn, containerId) {
        const roleId = btn.dataset.roleId;
        const saveStatus = document.getElementById('save-status-' + roleId);
        let currentUsers = [];
        try { currentUsers = JSON.parse(btn.dataset.users) || []; } catch(e) {}

        const dialog = new BX.UI.EntitySelector.Dialog({
            id: 'portal-hub-role-' + roleId,
            context: 'PORTAL_HUB_ROLE_EDIT',
            targetNode: btn,
            entities: [{ id: 'user' }],
            multiple: true,
            enableSearch: true,
            width: 500,
            dropdownMode: false,
            selectedItems: currentUsers.map(u => ({ entityId: 'user', id: String(u.id) }))
        });

        dialog.subscribe('onHide', () => {
            const items = dialog.getSelectedItems();
            const ids = items.map(i => i.id);
            saveStatus.innerHTML = '<div class="ui-alert ui-alert-primary"><span class="ui-alert-message">Сохраняем...</span></div>';
            saveRole(roleId, ids, data => {
                if (data.status === 'success') {
                    saveStatus.innerHTML = '<div class="ui-alert ui-alert-success"><span class="ui-alert-message">Изменения сохранены.</span></div>';
                    setTimeout(() => saveStatus.innerHTML = '', 2500);
                } else {
                    saveStatus.innerHTML = '<div class="ui-alert ui-alert-danger"><span class="ui-alert-message">Ошибка при сохранении.</span></div>';
                }
            });
        });

        dialog.show();
    }

    BX.bindDelegate(document.body, 'click', {className: 'js-edit-role'}, function(e) {
        openSelector(e.target, 'user-selector-admin-' + e.target.dataset.roleId);
    });
    BX.bindDelegate(document.body, 'click', {className: 'js-edit-user-role'}, function(e) {
        openSelector(e.target, 'user-selector-user-' + e.target.dataset.roleId);
    });
});
</script>
<?php endif; ?>
