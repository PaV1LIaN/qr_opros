<?php
require($_SERVER["DOCUMENT_ROOT"]."/bitrix/header.php");
$APPLICATION->SetTitle("Портал сайтов");

use Bitrix\Main\Context;
use Bitrix\Main\Loader;

Loader::includeModule("iblock");

// --- ищем инфоблок ---
$iblockCode = "portal_sites"; 
$iblockType = "portal";       

$iblockRes = CIBlock::GetList([], ["CODE" => $iblockCode, "TYPE" => $iblockType])->Fetch();
if ($iblockRes) {
    $IBLOCK_ID = $iblockRes["ID"];
} else {
    die("<pre style='color:red'>Инфоблок portal_sites не найден.</pre>");
}

// --- папка для сайтов ---
$sitesDir = $_SERVER["DOCUMENT_ROOT"]."/local/portal_hub/sites/";
if (!is_dir($sitesDir)) {
    mkdir($sitesDir, 0755, true);
}

$request = Context::getCurrent()->getRequest();

// --- обработка формы ---
if ($request->isPost() && check_bitrix_sessid()) {
    $siteTitle = trim($request->getPost("SITE_TITLE")); // русское название
    $siteCode  = trim($request->getPost("SITE_CODE"));  // английский код

    if ($siteTitle !== "") {
        // если код пустой → генерируем транслитом
        if ($siteCode === "") {
            $siteCode = CUtil::translit($siteTitle, "ru", [
                "replace_space" => "_",
                "replace_other" => "_",
                "change_case" => "L",
            ]);
        }

        // очищаем код
        $folderName = preg_replace('/[^a-z0-9_-]/', '', strtolower($siteCode));

        // --- проверка на существование ---
        $baseName = $folderName;
        $counter = 2;

        // проверяем инфоблок
        while (CIBlockElement::GetList([], ["IBLOCK_ID" => $IBLOCK_ID, "CODE" => $folderName])->Fetch()) {
            $folderName = $baseName . "_" . $counter;
            $counter++;
        }

        // проверяем папку
        while (is_dir($sitesDir . $folderName)) {
            $folderName = $baseName . "_" . $counter;
            $counter++;
        }

        // --- создаём элемент в инфоблоке ---
        $el = new CIBlockElement;
        $arFields = [
            "IBLOCK_ID" => $IBLOCK_ID,
            "NAME" => $siteTitle,   // русское название
            "CODE" => $folderName,  // уникальный английский код
        ];
        $id = $el->Add($arFields);

        if (!$id) {
            echo "<pre style='color:red'>Ошибка инфоблока: ".$el->LAST_ERROR."</pre>";
        } else {
            // создаём папку
            $path = $sitesDir.$folderName;
            if (!is_dir($path)) {
                mkdir($path, 0755, true);

                // index.php
                file_put_contents(
                    $path."/index.php",
                    "<?php\nrequire(\$_SERVER['DOCUMENT_ROOT'].'/bitrix/header.php');\n".
                    "\$APPLICATION->SetTitle('$siteTitle');\n?>\n".
                    "<h1>Добро пожаловать на $siteTitle</h1>\n".
                    "<?php\nrequire(\$_SERVER['DOCUMENT_ROOT'].'/bitrix/footer.php');\n?>"
                );

                mkdir($path."/css", 0755, true);
                mkdir($path."/js", 0755, true);
                mkdir($path."/img", 0755, true);
            }
            echo "<pre style='color:green'>Сайт \"$siteTitle\" создан (#$id), папка: $folderName</pre>";
        }
    }
}

// --- список сайтов ---
$sites = [];
$res = CIBlockElement::GetList(
    ["ID" => "ASC"],
    ["IBLOCK_ID" => $IBLOCK_ID],
    false,
    false,
    ["ID", "NAME", "CODE"]
);
while ($ar = $res->GetNext()) {
    $sites[] = $ar;
}
?>

<h1>Портал сайтов</h1>

<form method="post">
    <?=bitrix_sessid_post()?>
    <input type="text" name="SITE_TITLE" placeholder="Название сайта (русское)" required>
    <input type="text" name="SITE_CODE" placeholder="Код сайта (латиница, если пусто — сгенерируется)">
    <button type="submit">Создать сайт</button>
</form>

<h2>Список сайтов</h2>
<ul>
<?foreach ($sites as $site):?>
    <li>
        <a href="/local/portal_hub/sites/<?=$site["CODE"]?>/" target="_blank">
            <?=$site["NAME"]?> (<?=$site["CODE"]?>)
        </a>
    </li>
<?endforeach;?>
</ul>

<?php require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php"); ?>
