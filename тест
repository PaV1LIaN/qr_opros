<?php
if (!defined("B_PROLOG_INCLUDED") || B_PROLOG_INCLUDED !== true) die();
global $USER;

use Bitrix\Main\UI\Extension;

if (!$USER->IsAdmin()) return;

// Загружаем стандартные UI-библиотеки Bitrix
Extension::load(['ui.entity-selector', 'main.core']);
?>

<div class="ui-block ui-block-section" style="padding:16px;">
    <div class="ui-block-title">
        <h3>Создать новый портал сайта</h3>
    </div>

    <form method="post" action="" class="ui-form">
        <?= bitrix_sessid_post() ?>
        <input type="hidden" name="create_site" value="Y" />

        <div class="ui-form-row">
            <div class="ui-form-label">Название сайта</div>
            <div class="ui-form-content">
                <input type="text" name="site_title" required class="ui-ctl ui-ctl-textbox" style="width:100%;">
            </div>
        </div>

        <div class="ui-form-row">
            <div class="ui-form-label">Код сайта (папка, латиница)</div>
            <div class="ui-form-content">
                <input type="text" name="site_code" class="ui-ctl ui-ctl-textbox" placeholder="Оставьте пустым — создастся автоматически">
            </div>
        </div>

        <div class="ui-form-row">
            <div class="ui-form-label">Название роли</div>
            <div class="ui-form-content">
                <input type="text" name="role_name" class="ui-ctl ui-ctl-textbox" placeholder="Например: Роль отдела продаж">
            </div>
        </div>

        <div class="ui-form-row">
            <div class="ui-form-label">Пользователи роли</div>
            <div class="ui-form-content">
                <!-- Поле для хранения выбранных ID -->
                <input type="hidden" name="role_users" id="role_users_input">

                <div id="user-selector" style="margin-bottom:10px;"></div>
                <button type="button" id="open-selector-btn" class="ui-btn ui-btn-light-border ui-btn-sm">
                    Выбрать пользователей
                </button>
            </div>
        </div>

        <div class="ui-form-row">
            <button type="submit" class="ui-btn ui-btn-success">Создать сайт</button>
        </div>
    </form>
</div>

<script>
BX.ready(function() {
    const selectorContainer = document.getElementById('user-selector');
    const hiddenInput = document.getElementById('role_users_input');
    const openBtn = document.getElementById('open-selector-btn');

    let selectedUsers = [];

    const dialog = new BX.UI.EntitySelector.Dialog({
        id: 'user-selector-dialog',
        context: 'USER_SELECT',
        targetNode: openBtn,
        entities: [{ id: 'user' }],
        multiple: true,
        compactView: false,
        enableSearch: true,
        width: 500,
        dropdownMode: false,
        events: {
            'Item:onSelect': updateDisplay,
            'Item:onDeselect': updateDisplay
        }
    });

    function updateDisplay() {
        selectedUsers = dialog.getSelectedItems().map(i => ({
            id: i.id,
            title: i.getTitle(),
            avatar: i.getAvatar()
        }));

        // визуальный вывод
        selectorContainer.innerHTML = '';
        selectedUsers.forEach(u => {
            const el = document.createElement('div');
            el.className = 'ui-label ui-label-light ui-label-fill-light';
            el.style.margin = '4px';
            el.innerHTML = '<span class="ui-label-inner">' +
                BX.util.htmlspecialchars(u.title) + '</span>';
            selectorContainer.appendChild(el);
        });

        hiddenInput.value = selectedUsers.map(u => u.id).join(',');
    }

    openBtn.addEventListener('click', () => {
        dialog.show();
    });
});
</script>
