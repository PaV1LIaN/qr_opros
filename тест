<?php
if (!defined("B_PROLOG_INCLUDED") || B_PROLOG_INCLUDED !== true) die();

use Bitrix\Main\UI\Extension;
Extension::load(['ui.forms', 'ui.buttons', 'ui.entity-selector', 'main.core']);

global $USER;
if (!$USER->IsAdmin()):
?>
<div class="ui-alert ui-alert-warning">
    <span class="ui-alert-message">У вас нет прав для создания порталов.</span>
</div>
<?php return; endif; ?>

<div class="ui-card" style="padding:24px; border-radius:12px; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,0.06); max-width:900px;">
    <h3 style="margin-bottom:18px; font-size:20px; font-weight:600;">Создание нового портала</h3>

    <form method="post">
        <?= bitrix_sessid_post() ?>
        <input type="hidden" name="create_site" value="Y">
        <input type="hidden" name="role_users" id="role_users_input">
        <input type="hidden" name="site_users" id="site_users_input">

        <div class="ui-form-row">
            <div class="ui-form-label">Название сайта</div>
            <div class="ui-form-content">
                <div class="ui-ctl ui-ctl-textbox">
                    <input type="text" name="site_title" class="ui-ctl-element" required>
                </div>
            </div>
        </div>

        <div class="ui-form-row">
            <div class="ui-form-label">Код сайта (папка)</div>
            <div class="ui-form-content">
                <div class="ui-ctl ui-ctl-textbox">
                    <input type="text" name="site_code" class="ui-ctl-element" required>
                </div>
            </div>
        </div>

        <div class="ui-form-row">
            <div class="ui-form-label">Название роли</div>
            <div class="ui-form-content">
                <div class="ui-ctl ui-ctl-textbox">
                    <input type="text" name="role_name" class="ui-ctl-element" required>
                </div>
            </div>
        </div>

        <div class="ui-form-row">
            <div class="ui-form-label">Администраторы сайта</div>
            <div class="ui-form-content">
                <div id="admin_tag_selector"></div>
            </div>
        </div>

        <div class="ui-form-row">
            <div class="ui-form-label">Обычные пользователи</div>
            <div class="ui-form-content">
                <div id="user_tag_selector"></div>
            </div>
        </div>

        <div class="ui-form-row" style="margin-top:16px;">
            <button type="submit" class="ui-btn ui-btn-success">Создать сайт</button>
        </div>
    </form>
</div>

<script>
BX.ready(function() {
    // TagSelector для администраторов
    const adminSelector = new BX.UI.EntitySelector.TagSelector({
        id: 'portal_admins_create',
        textBoxWidth: '100%',
        multiple: true,
        dialogOptions: {
            id: 'portal_admins_dialog',
            context: 'PORTAL_CREATE',
            entities: [{ id: 'user' }],
            enableSearch: true,
            width: 500
        },
        events: {
            onChange: syncAdmins
        }
    });
    adminSelector.renderTo(document.getElementById('admin_tag_selector'));

    // TagSelector для обычных пользователей
    const userSelector = new BX.UI.EntitySelector.TagSelector({
        id: 'portal_users_create',
        textBoxWidth: '100%',
        multiple: true,
        dialogOptions: {
            id: 'portal_users_dialog',
            context: 'PORTAL_CREATE',
            entities: [{ id: 'user' }],
            enableSearch: true,
            width: 500
        },
        events: {
            onChange: syncUsers
        }
    });
    userSelector.renderTo(document.getElementById('user_tag_selector'));

    function syncAdmins() {
        const ids = adminSelector.getTags().map(t => t.id);
        document.getElementById('role_users_input').value = ids.join(',');
    }

    function syncUsers() {
        const ids = userSelector.getTags().map(t => t.id);
        document.getElementById('site_users_input').value = ids.join(',');
    }
});
</script>
