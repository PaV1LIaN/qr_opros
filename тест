use Bitrix\Main\Loader;
use Bitrix\Disk\Driver;

public function ensureSiteDiskFolder(int $siteId, string $siteCode, string $siteName = ''): int
{
    if (!Loader::includeModule('disk')) {
        throw new \Exception('Модуль disk не установлен');
    }

    // Диск компании (Общие документы)
    $storage = Driver::getInstance()->getStorageByCommonId('shared_files');
    if (!$storage) {
        throw new \Exception('Не найден storage shared_files (Диск компании)');
    }

    $root = $storage->getRootObject();
    if (!$root) {
        throw new \Exception('Не найден root folder Диска компании');
    }

    // Название папки: "TS_<code>" (можешь поменять)
    $folderName = 'TS_' . $this->normalizeSlug($siteCode);

    // Если уже создана и записана — просто вернём
    $site = $this->getSiteById($siteId); // если у тебя есть такой метод; иначе получи сайт как умеешь
    $existingId = (int)($site['UF_DISK_FOLDER_ID'] ?? 0);
    if ($existingId > 0) {
        return $existingId;
    }

    // Попробуем найти папку по имени (на случай, если создавалась вручную)
    $children = $root->getChildren([
        'filter' => ['=NAME' => $folderName],
        'limit'  => 1,
    ]);
    if (!empty($children)) {
        $folder = $children[0];
        return (int)$folder->getId();
    }

    // Создаём
    $folder = $root->addSubFolder([
        'NAME' => $folderName,
    ], $this->getCurrentUserId()); // сделай метод getCurrentUserId() или передай ID пользователя

    if (!$folder) {
        throw new \Exception('Не удалось создать папку в Диске компании');
    }

    return (int)$folder->getId();
}
