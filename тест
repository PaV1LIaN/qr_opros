<?php
if (!defined("B_PROLOG_INCLUDED") || B_PROLOG_INCLUDED !== true) die();

use Bitrix\Main\UI\Extension;
Extension::load(['ui.buttons', 'ui.dialogs.messagebox', 'ui.entity-selector', 'ui.alerts', 'main.core']);

global $USER;

if (empty($sites)): ?>
    <div class="ui-alert ui-alert-warning">
        <span class="ui-alert-message">Нет доступных сайтов.</span>
    </div>
<?php return; endif; ?>

<div class="ui-card" style="padding:24px; background:#fff; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
    <h3 style="font-size:20px; font-weight:600; margin-bottom:20px;">Доступные сайты</h3>

    <div class="ui-grid ui-grid--no-gutters ui-grid--wrap">
        <?php foreach ($sites as $site): 
            $siteUrl = "/local/portal_hub/sites/" . htmlspecialcharsbx($site['CODE']) . "/";

            $roleAdminId = (int)$site["ROLE_ADMIN"];
            $roleUserId  = (int)$site["ROLE_USER"];

            // Загружаем пользователей ролей
            $admins = [];
            if ($roleAdminId > 0) {
                $rs = \CUser::GetList($by = "id", $order = "asc", ["GROUPS_ID" => [$roleAdminId]], ["FIELDS" => ["ID","NAME","LAST_NAME","LOGIN"]]);
                while ($u = $rs->Fetch()) {
                    $title = trim($u["NAME"]." ".$u["LAST_NAME"]);
                    if ($title === "") { $title = $u["LOGIN"]; }
                    $admins[] = ["id" => (int)$u["ID"], "title" => $title];
                }
            }

            $users = [];
            if ($roleUserId > 0) {
                $rs = \CUser::GetList($by = "id", $order = "asc", ["GROUPS_ID" => [$roleUserId]], ["FIELDS" => ["ID","NAME","LAST_NAME","LOGIN"]]);
                while ($u = $rs->Fetch()) {
                    $title = trim($u["NAME"]." ".$u["LAST_NAME"]);
                    if ($title === "") { $title = $u["LOGIN"]; }
                    $users[] = ["id" => (int)$u["ID"], "title" => $title];
                }
            }
        ?>
        <div class="ui-grid__col ui-col-12 ui-col-md-6 ui-col-lg-4" style="padding:12px;">
            <div class="ui-card" style="padding:16px; border-radius:10px; background:#fafafa; height:100%;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <a href="<?= htmlspecialcharsbx($siteUrl) ?>" style="font-size:18px; font-weight:600; color:#0066cc; text-decoration:none;">
                        <?= htmlspecialcharsbx($site["NAME"]) ?>
                    </a>
                    <?php if ($USER->IsAdmin()): ?>
                        <span class="ui-label ui-label-success" style="font-size:12px;">Админ</span>
                    <?php endif; ?>
                </div>

                <div style="margin-top:12px;">
                    <div style="font-size:13px; font-weight:500;">Администраторы:</div>
                    <?php if (!empty($admins)): ?>
                        <div id="admin_list_<?= $site['ID'] ?>" style="margin:4px 0;">
                            <?php foreach ($admins as $a): ?>
                                <span class="ui-label ui-label-light ui-label-sm" style="margin-right:4px;"><?= htmlspecialcharsbx($a['title']) ?></span>
                            <?php endforeach; ?>
                        </div>
                    <?php else: ?>
                        <div><i>нет</i></div>
                    <?php endif; ?>
                    <?php if ($USER->IsAdmin()): ?>
                        <button type="button"
                                class="ui-btn ui-btn-xs ui-btn-light-border js-edit-role"
                                data-role-id="<?= $roleAdminId ?>"
                                data-users='<?= json_encode($admins, JSON_UNESCAPED_UNICODE) ?>'>
                            Редактировать
                        </button>
                    <?php endif; ?>
                </div>

                <div style="margin-top:12px;">
                    <div style="font-size:13px; font-weight:500;">Пользователи:</div>
                    <?php if (!empty($users)): ?>
                        <div id="user_list_<?= $site['ID'] ?>" style="margin:4px 0;">
                            <?php foreach ($users as $u): ?>
                                <span class="ui-label ui-label-light ui-label-sm" style="margin-right:4px;"><?= htmlspecialcharsbx($u['title']) ?></span>
                            <?php endforeach; ?>
                        </div>
                    <?php else: ?>
                        <div><i>нет</i></div>
                    <?php endif; ?>
                    <?php if ($USER->IsAdmin()): ?>
                        <button type="button"
                                class="ui-btn ui-btn-xs ui-btn-light-border js-edit-user-role"
                                data-role-id="<?= $roleUserId ?>"
                                data-users='<?= json_encode($users, JSON_UNESCAPED_UNICODE) ?>'>
                            Редактировать
                        </button>
                    <?php endif; ?>
                </div>

                <div id="save-status-<?= $site['ID'] ?>" style="margin-top:10px;"></div>
            </div>
        </div>
        <?php endforeach; ?>
    </div>
</div>

<?php if ($USER->IsAdmin()): ?>
<script>
BX.ready(function () {
    const BX_SESSID = '<?= bitrix_sessid() ?>';

    function saveRole(roleId, userIds, onDone) {
        const fd = new FormData();
        fd.append('AJAX', 'UPDATE_ROLE');
        fd.append('sessid', BX_SESSID);
        fd.append('ROLE_ID', roleId);
        userIds.forEach(id => fd.append('ROLE_USERS[]', id));

        fetch(location.href, { method: 'POST', body: fd, credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => onDone && onDone(data))
            .catch(() => onDone && onDone({ status: 'error' }));
    }

    function openSelector(btn, listContainer) {
        const roleId = btn.dataset.roleId;
        const container = document.getElementById(listContainer);
        const saveStatus = document.getElementById('save-status-' + roleId);

        let currentUsers = [];
        try { currentUsers = JSON.parse(btn.dataset.users) || []; } catch(e) {}

        const dialog = new BX.UI.EntitySelector.Dialog({
            id: 'portal-hub-role-' + roleId,
            context: 'PORTAL_HUB_ROLE_EDIT',
            targetNode: btn,
            entities: [{ id: 'user' }],
            multiple: true,
            enableSearch: true,
            selectedItems: currentUsers.map(u => ({ entityId: 'user', id: String(u.id) }))
        });

        dialog.subscribe('onHide', () => {
            const items = dialog.getSelectedItems();
            const ids = items.map(i => i.id);

            saveStatus.innerHTML = '<div class="ui-alert ui-alert-primary"><span class="ui-alert-message">Сохраняем...</span></div>';

            saveRole(roleId, ids, data => {
                if (data.status === 'success') {
                    saveStatus.innerHTML = '<div class="ui-alert ui-alert-success"><span class="ui-alert-message">Изменения сохранены</span></div>';
                    setTimeout(() => saveStatus.innerHTML = '', 2500);

                    // обновляем список пользователей на карточке
                    container.innerHTML = '';
                    items.forEach(i => {
                        const span = document.createElement('span');
                        span.className = 'ui-label ui-label-light ui-label-sm';
                        span.style.marginRight = '4px';
                        span.textContent = i.title || i.name;
                        container.appendChild(span);
                    });
                } else {
                    saveStatus.innerHTML = '<div class="ui-alert ui-alert-danger"><span class="ui-alert-message">Ошибка при сохранении</span></div>';
                }
            });
        });

        dialog.show();
    }

    BX.bindDelegate(document.body, 'click', {className: 'js-edit-role'}, function(e) {
        openSelector(e.target, 'admin_list_' + e.target.closest('.ui-card').querySelector('a').textContent);
    });

    BX.bindDelegate(document.body, 'click', {className: 'js-edit-user-role'}, function(e) {
        openSelector(e.target, 'user_list_' + e.target.closest('.ui-card').querySelector('a').textContent);
    });
});
</script>
<?php endif; ?>
