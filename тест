<?php
require($_SERVER["DOCUMENT_ROOT"]."/bitrix/header.php");

use PortalHub\Manager as PH;

global $USER;

$code = (string)($_REQUEST['code'] ?? '');
$code = trim($code);

if ($code === '') {
    ShowError('Сайт не найден');
    require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php"); return;
}

$el = PH::getSiteByCode($code);
if (!$el) {
    ShowError('Сайт не найден');
    require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php"); return;
}

// Проверка доступа
$roleId = (int)($el['PROPERTY_SITE_ROLE_VALUE'] ?? 0);
$hasAccess = $roleId <= 0 || in_array($roleId, (array)$USER->GetUserGroupArray(), true) || $USER->IsAdmin();

if (!$hasAccess) {
    ShowError('Доступ запрещён');
    require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php"); return;
}

// TODO: здесь можно подключать ваши компоненты портала (dashboard, виджеты и т.д.)
?><div style="padding:16px">
    <h2 style="margin:0 0 12px"><?= htmlspecialcharsbx($el['NAME']) ?></h2>
    <div class="ui-alert ui-alert-primary">
        <span class="ui-alert-message">
            Это заглушка страницы портала <b><?= htmlspecialcharsbx($el['CODE']) ?></b>. Подключите здесь ваши компоненты.
        </span>
    </div>
</div><?php

require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");
