<?php
require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/header.php");

use Bitrix\Main\Context;

require_once $_SERVER["DOCUMENT_ROOT"] . "/local/typical_sites/lib/SiteService.php";

global $USER, $APPLICATION;

$request = Context::getCurrent()->getRequest();

$code = trim((string)$request->getQuery('code'));
$pageId = (int)$request->getQuery('page_id');
$showDeleted = ($request->getQuery('show_deleted') === 'Y');

if ($code === '' || $pageId <= 0) {
    ShowError("Не указан code или page_id");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

if (!$USER->IsAuthorized()) {
    ShowError("Требуется авторизация");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

$service = new \Cc10\SiteService();

$site = $service->getSiteByCode($code);
if (!$site) {
    ShowError("Сайт не найден или не активен");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

$siteId = (int)$site['ID'];
$role = $service->getUserRole((int)$USER->GetID(), $siteId);

if (!$USER->IsAdmin() && !in_array($role, ['ADMIN','DEVELOPER'], true)) {
    ShowError("Нет прав на редактирование блоков");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

$page = $service->getPageById($pageId);
if (!$page || (int)$page['UF_SITE'] !== $siteId) {
    ShowError("Страница не найдена или не принадлежит этому сайту");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

$errors = [];

// POST: удалить/восстановить блок
if ($request->isPost() && check_bitrix_sessid()) {
    $action = (string)$request->getPost('action');
    $blockId = (int)$request->getPost('block_id');

    try {
        if ($blockId > 0 && $action === 'delete') {
            $service->softDeleteBlock($blockId, $siteId, (int)$page['ID'], (int)$USER->GetID());

            $service->logAction($siteId, (int)$USER->GetID(), 'BLOCK_DELETE', 'block', $blockId, [
                'page_id' => (int)$page['ID'],
                'soft' => true,
            ]);
        } elseif ($blockId > 0 && $action === 'restore') {
            $service->restoreBlock($blockId, $siteId, (int)$page['ID']);

            $service->logAction($siteId, (int)$USER->GetID(), 'BLOCK_RESTORE', 'block', $blockId, [
                'page_id' => (int)$page['ID'],
            ]);
        }

        LocalRedirect('/local/typical_sites/blocks.php?code=' . urlencode($code) . '&page_id=' . (int)$page['ID'] . ($showDeleted ? '&show_deleted=Y' : ''));
    } catch (\Throwable $e) {
        $errors[] = $e->getMessage();
    }
}

// Получаем блоки
// Если show_deleted=Y — нужен список и удалённых тоже.
// Если у тебя в сервисе getBlocksForPage всегда фильтрует deleted, то для удалённых нужен отдельный метод.
// Самый простой вариант: добавить в сервис метод getBlocksForPageAny($siteId,$pageId,$onlyActive=false,$includeDeleted=true).
// Но чтобы тебе не усложнять — ниже вариант ожидает, что getBlocksForPage НЕ включает deleted при showDeleted=Y.
// Если сейчас getBlocksForPage уже фильтрует deleted жёстко — скажи, дам маленький метод для "includeDeleted".

if ($showDeleted) {
    // временно используем getBlocksForPage(..., false) и предполагаем что он отдаёт всё (включая deleted)
    // Если у тебя фильтр deleted уже стоит внутри — добавь отдельный метод в сервис.
    $blocks = $service->getBlocksForPage($siteId, (int)$page['ID'], false);
} else {
    $blocks = $service->getBlocksForPage($siteId, (int)$page['ID'], false);
    // предполагаем что deleted уже отфильтрован в сервисе (как мы и делали)
}

$APPLICATION->SetTitle("Блоки страницы");
?>

<h1>Блоки: <?= htmlspecialcharsbx((string)$site['UF_NAME']) ?> / <?= htmlspecialcharsbx((string)$page['UF_TITLE']) ?></h1>

<p>
    <a href="/local/typical_sites/pages.php?code=<?= urlencode($code) ?>">← К списку страниц</a>
    &nbsp;|&nbsp;
    <a href="/local/typical_sites/page_edit.php?code=<?= urlencode($code) ?>&page_id=<?= (int)$page['ID'] ?>">Редактировать страницу</a>
</p>

<p>
    <a href="/local/typical_sites/block_edit.php?code=<?= urlencode($code) ?>&page_id=<?= (int)$page['ID'] ?>">+ Добавить блок</a>
    &nbsp;|&nbsp;
    <a href="/local/typical_sites/site.php?code=<?= urlencode($code) ?>&page=<?= urlencode((string)$page['UF_SLUG']) ?>" target="_blank">Открыть страницу</a>
</p>

<p style="margin:10px 0;">
    <?php
    $toggleUrl = '/local/typical_sites/blocks.php?code=' . urlencode($code) . '&page_id=' . (int)$page['ID'] . ($showDeleted ? '' : '&show_deleted=Y');
    ?>
    <a href="<?= htmlspecialcharsbx($toggleUrl) ?>">
        <?= $showDeleted ? 'Скрыть удалённые' : 'Показать удалённые' ?>
    </a>
</p>

<?php if (!empty($errors)): ?>
    <div style="color:red; margin:10px 0;">
        <?php foreach ($errors as $e): ?>
            <div><?= htmlspecialcharsbx($e) ?></div>
        <?php endforeach; ?>
    </div>
<?php endif; ?>

<?php if (empty($blocks)): ?>
    <p>Блоков пока нет.</p>
<?php else: ?>
    <table border="1" cellpadding="6" cellspacing="0">
        <tr>
            <th>ID</th>
            <th>TYPE</th>
            <th>Заголовок</th>
            <th>SORT</th>
            <th>Активен</th>
            <th>Удалён</th>
            <th>Действия</th>
        </tr>

        <?php foreach ($blocks as $b): ?>
            <?php $isDeleted = !empty($b['UF_DELETED']); ?>
            <?php if (!$showDeleted && $isDeleted) continue; ?>

            <tr>
                <td><?= (int)$b['ID'] ?></td>
                <td><?= htmlspecialcharsbx((string)$b['UF_TYPE']) ?></td>
                <td><?= htmlspecialcharsbx((string)$b['UF_TITLE']) ?></td>
                <td><?= (int)$b['UF_SORT'] ?></td>
                <td><?= ($b['UF_ACTIVE'] ? 'Y' : 'N') ?></td>
                <td><?= ($isDeleted ? 'Y' : 'N') ?></td>
                <td>
                    <?php if (!$isDeleted): ?>
                        <a href="/local/typical_sites/block_edit.php?code=<?= urlencode($code) ?>&page_id=<?= (int)$page['ID'] ?>&block_id=<?= (int)$b['ID'] ?>">Редактировать</a>
                        |
                        <form method="post" style="display:inline;" onsubmit="return confirm('Удалить блок (в корзину)?');">
                            <?= bitrix_sessid_post() ?>
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="block_id" value="<?= (int)$b['ID'] ?>">
                            <button type="submit">Удалить</button>
                        </form>
                    <?php else: ?>
                        <form method="post" style="display:inline;" onsubmit="return confirm('Восстановить блок?');">
                            <?= bitrix_sessid_post() ?>
                            <input type="hidden" name="action" value="restore">
                            <input type="hidden" name="block_id" value="<?= (int)$b['ID'] ?>">
                            <button type="submit">Восстановить</button>
                        </form>
                    <?php endif; ?>
                </td>
            </tr>
        <?php endforeach; ?>
    </table>
<?php endif; ?>

<?php
require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
