<?php
require($_SERVER["DOCUMENT_ROOT"]."/bitrix/header.php");
$APPLICATION->SetTitle("Админка типовых сайтов");
$APPLICATION->SetAdditionalCSS("/local/typical_sites/assets/style.css");

global $USER;
if (!$USER->IsAdmin()) {
    ShowError("Доступ запрещён");
    require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");
    exit;
}

require_once $_SERVER["DOCUMENT_ROOT"] . "/local/typical_sites/lib/SiteService.php";
$service = new \Cc10\SiteService();

// действия (POST)
$request = \Bitrix\Main\Context::getCurrent()->getRequest();
$errors = [];

if ($request->isPost() && check_bitrix_sessid()) {
    $action = (string)$request->getPost('action');
    $siteId = (int)$request->getPost('site_id');

    try {
        if ($action === 'disable') {
            $service->setActive($siteId, false);
        } elseif ($action === 'enable') {
            $service->setActive($siteId, true);
        } elseif ($action === 'delete') {
            $service->deleteSite($siteId);
        }
        LocalRedirect('/local/typical_sites/admin.php');
    } catch (\Throwable $e) {
        $errors[] = $e->getMessage();
    }
}

$sites = $service->getAllSites();
?>

<div class="ts-wrap">

  <div class="ts-header">
    <h1 class="ts-title">Администрирование типовых сайтов</h1>
    <a class="ts-btn" href="/local/typical_sites/manage.php">+ Создать сайт</a>
  </div>

  <div class="ts-card">
    <div class="ts-row">
      <label>Поиск:</label>
      <input class="ts-input" type="text" id="ts-search" placeholder="Название или CODE..." style="width:280px;">
      <span class="ts-badge" id="ts-count"><?= count($sites) ?></span>
    </div>
  </div>

  <?php if (!empty($errors)): ?>
    <div class="ts-error ts-card">
      <?php foreach ($errors as $e): ?>
        <div><?= htmlspecialcharsbx($e) ?></div>
      <?php endforeach; ?>
    </div>
  <?php endif; ?>

  <?php if (empty($sites)): ?>
      <div class="ts-card">Сайтов пока нет.</div>
  <?php else: ?>
      <div class="ts-card">
        <table class="ts-table" id="ts-table">
          <thead>
            <tr>
              <th style="width:70px;">ID</th>
              <th>Название</th>
              <th style="width:180px;">CODE</th>
              <th>URL</th>
              <th style="width:90px;">Активен</th>
              <th style="width:260px;">Действия</th>
            </tr>
          </thead>
          <tbody>
            <?php foreach ($sites as $s): ?>
              <?php
                $code = (string)$s['UF_CODE'];
                $url = '/local/typical_sites/site.php?code=' . urlencode($code);
                $isActive = !empty($s['UF_ACTIVE']);
                $searchKey = mb_strtolower(trim((string)$s['UF_NAME'] . ' ' . $code));
              ?>
              <tr class="ts-site-row" data-search="<?= htmlspecialcharsbx($searchKey) ?>">
                <td><?= (int)$s['ID'] ?></td>
                <td><?= htmlspecialcharsbx((string)$s['UF_NAME']) ?></td>
                <td><span class="ts-badge"><?= htmlspecialcharsbx($code) ?></span></td>
                <td><a href="<?= htmlspecialcharsbx($url) ?>" target="_blank"><?= htmlspecialcharsbx($url) ?></a></td>
                <td>
                  <?php if ($isActive): ?>
                    <span class="ts-badge ts-badge-ok">Y</span>
                  <?php else: ?>
                    <span class="ts-badge ts-badge-off">N</span>
                  <?php endif; ?>
                </td>
                <td>
                  <a class="ts-btn" href="/local/typical_sites/access_manage.php?code=<?= urlencode($code) ?>">Доступы</a>
                  <a class="ts-btn" href="/local/typical_sites/pages.php?code=<?= urlencode($code) ?>">Страницы</a>

                  <form method="post" style="display:inline;">
                    <?= bitrix_sessid_post() ?>
                    <input type="hidden" name="site_id" value="<?= (int)$s['ID'] ?>">
                    <?php if ($isActive): ?>
                      <button class="ts-btn" type="submit" name="action" value="disable">Выключить</button>
                    <?php else: ?>
                      <button class="ts-btn" type="submit" name="action" value="enable">Включить</button>
                    <?php endif; ?>
                  </form>

                  <form method="post" style="display:inline;" onsubmit="return confirm('Точно удалить сайт?');">
                    <?= bitrix_sessid_post() ?>
                    <input type="hidden" name="site_id" value="<?= (int)$s['ID'] ?>">
                    <button class="ts-btn ts-btn-danger" type="submit" name="action" value="delete">Удалить</button>
                  </form>
                </td>
              </tr>
            <?php endforeach; ?>
          </tbody>
        </table>
      </div>
  <?php endif; ?>

</div>

<script>
(function(){
  const input = document.getElementById('ts-search');
  const rows = document.querySelectorAll('.ts-site-row');
  const badge = document.getElementById('ts-count');

  function apply(){
    const q = (input.value || '').toLowerCase().trim();
    let shown = 0;
    rows.forEach(r => {
      const key = (r.getAttribute('data-search') || '');
      const ok = (q === '' || key.includes(q));
      r.style.display = ok ? '' : 'none';
      if (ok) shown++;
    });
    if (badge) badge.textContent = shown;
  }

  if (input) input.addEventListener('input', apply);
})();
</script>

<?php
require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");
