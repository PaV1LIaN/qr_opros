<?php
namespace PortalHub;

use Bitrix\Main\Loader;

class Manager
{
    /** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ID –∏–Ω—Ñ–æ–±–ª–æ–∫–∞ —Å –∫–æ–¥–æ–º portal_sites */
    public static function getPortalIblockId(): int
    {
        if (!Loader::includeModule('iblock')) {
            return 0;
        }
        $res = \CIBlock::GetList([], ['=CODE' => 'portal_sites'], false);
        if ($ib = $res->Fetch()) {
            return (int)$ib['ID'];
        }
        return 0;
    }

    /** –ü—Ä–∏–≤–æ–¥–∏–º –∫–æ–¥ —Å–∞–π—Ç–∞ –∫ —Å–ª–∞–≥—É */
    public static function sanitizeCode(string $code): string
    {
        $code = mb_strtolower($code);
        $code = preg_replace('~\s+~u', '-', $code);
        $code = preg_replace('~[^a-z0-9\-_]~u', '', $code);
        $code = trim($code, '-_');
        return $code ?: 'site';
    }

    /** –£–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞ —Å–∞–π—Ç–∞ */
    private static function generateUniqueCode(int $IBLOCK_ID, string $siteTitle, string $siteCode): string
    {
        $base = self::sanitizeCode($siteCode !== '' ? $siteCode : $siteTitle);
        if ($base === '') { $base = 'site'; }

        $code = $base;
        $n = 1;
        while (\CIBlockElement::GetList([], ["IBLOCK_ID"=>$IBLOCK_ID, "=CODE"=>$code], false, false, ["ID"])->Fetch()) {
            $n++;
            $code = $base . '-' . $n;
        }
        return $code;
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–π—Ç–∞ + —Ä–æ–ª–∏ + —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
     *   ["success"=>true, "id"=>int] |
     *   ["success"=>false, "status"=>"exists", "message"=>string] |
     *   ["success"=>false, "message"=>string]
     */
    public static function createPortalSite(string $siteTitle, string $siteCode, string $roleName, array $roleUsers = []): array
    {
        if (!Loader::includeModule('iblock')) {
            return ["success" => false, "message" => "–ú–æ–¥—É–ª—å –∏–Ω—Ñ–æ–±–ª–æ–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω"];
        }

        $IBLOCK_ID = self::getPortalIblockId();
        if ($IBLOCK_ID <= 0) {
            return ["success" => false, "message" => "–ò–Ω—Ñ–æ–±–ª–æ–∫ 'portal_sites' –Ω–µ –Ω–∞–π–¥–µ–Ω"];
        }

        $siteTitle = trim($siteTitle);
        $siteCode  = trim($siteCode);
        $roleName  = trim($roleName);

        if ($siteTitle === "" || $roleName === "") {
            return ["success" => false, "message" => "–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–π—Ç–∞ –∏ —Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã"];
        }

        // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π CODE (–µ—Å–ª–∏ –ø—É—Å—Ç –∏–ª–∏ –∑–∞–Ω—è—Ç ‚Äî –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è)
        $siteCode = self::generateUniqueCode($IBLOCK_ID, $siteTitle, $siteCode);

        // üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–µ–π –ø–æ NAME –∏–ª–∏ CODE (–Ω–∞ —Å–ª—É—á–∞–π –≥–æ–Ω–æ–∫)
        $exists = \CIBlockElement::GetList(
            [],
            [
                "IBLOCK_ID" => $IBLOCK_ID,
                "ACTIVE"    => "Y",
                [
                    "LOGIC" => "OR",
                    ["=NAME" => $siteTitle],
                    ["=CODE" => $siteCode],
                ],
            ],
            false,
            false,
            ["ID","NAME","CODE"]
        )->Fetch();

        if ($exists) {
            return [
                "success" => false,
                "status"  => "exists",
                "message" => "–°–∞–π—Ç —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∏–ª–∏ –∫–æ–¥–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç",
                "code"    => (string)$exists["CODE"],
                "name"    => (string)$exists["NAME"],
            ];
        }

        // üß± –°–æ–∑–¥–∞—ë–º –∏–ª–∏ –±–µ—Ä—ë–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –≥—Ä—É–ø–ø—É (—Ä–æ–ª—å)
        $stringId = "portal_role_" . $siteCode;
        $by = "c_sort"; $order = "asc";
        $existingGroup = \CGroup::GetList($by, $order, ["STRING_ID" => $stringId])->Fetch();
        if ($existingGroup) {
            $roleId = (int)$existingGroup['ID'];
        } else {
            $group = new \CGroup;
            $roleId = $group->Add([
                "ACTIVE"    => "Y",
                "C_SORT"    => 100,
                "NAME"      => $roleName,
                "STRING_ID" => $stringId,
            ]);
            if (!$roleId) {
                return ["success" => false, "message" => "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É —Ä–æ–ª–∏"];
            }
        }

        // üë• –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ä–æ–ª—å
        $roleUsers = array_unique(array_map('intval', $roleUsers));
        foreach ($roleUsers as $uid) {
            if ($uid <= 0) { continue; }
            $groups = (array)\CUser::GetUserGroup($uid);
            $groups = array_map('intval', $groups);
            if (!in_array((int)$roleId, $groups, true)) {
                $groups[] = (int)$roleId;
                \CUser::SetUserGroup($uid, $groups);
            }
        }

        // üóÇÔ∏è –°–æ–∑–¥–∞—ë–º —ç–ª–µ–º–µ–Ω—Ç –∏–Ω—Ñ–æ–±–ª–æ–∫–∞ –¥–ª—è —Å–∞–π—Ç–∞
        $el = new \CIBlockElement;
        $id = $el->Add([
            "IBLOCK_ID"        => $IBLOCK_ID,
            "ACTIVE"           => "Y",
            "NAME"             => $siteTitle,
            "CODE"             => $siteCode,
            "PROPERTY_VALUES"  => [
                "SITE_ROLE" => (int)$roleId,
            ],
        ]);
        if (!$id) {
            // –û—Ç–∫–∞—Ç: —É–¥–∞–ª—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—É—é –≥—Ä—É–ø–ø—É (–µ—Å–ª–∏ –æ–Ω–∞ —Ç–æ–ª—å–∫–æ —á—Ç–æ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞)
            if (empty($existingGroup)) {
                \CGroup::Delete((int)$roleId);
            }
            return ["success" => false, "message" => "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–∞–π—Ç–∞: ".$el->LAST_ERROR];
        }

        return ["success" => true, "id" => (int)$id];
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∞–π—Ç—ã, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ –≥—Ä—É–ø–ø–∞–º.
     * –£ –∞–¥–º–∏–Ω–æ–≤ ‚Äî –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–∞–π—Ç—ã.
     */
    public static function getPortalSites(array $userGroups): array
    {
        if (!Loader::includeModule('iblock')) {
            return [];
        }
        $IBLOCK_ID = self::getPortalIblockId();
        if ($IBLOCK_ID <= 0) {
            return [];
        }

        global $USER;
        $isAdmin = (is_object($USER) && $USER->IsAdmin()) || in_array(1, array_map('intval', $userGroups), true);

        $filter = [
            "IBLOCK_ID" => $IBLOCK_ID,
            "ACTIVE"    => "Y",
        ];

        if (!$isAdmin) {
            $ug = array_map('intval', $userGroups);
            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–∞–π—Ç—ã –±–µ–∑ —Ä–æ–ª–∏ (–ø—É–±–ª–∏—á–Ω—ã–µ) –ò–õ–ò —Å —Ä–æ–ª—å—é, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –ª—é–±–æ–π –≥—Ä—É–ø–ø–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            $filter[] = [
                "LOGIC" => "OR",
                ["!PROPERTY_SITE_ROLE" => false, "PROPERTY_SITE_ROLE" => $ug],
                ["PROPERTY_SITE_ROLE" => false],
            ];
        }

        $sites = [];
        $res = \CIBlockElement::GetList(
            ["NAME" => "ASC"],
            $filter,
            false,
            false,
            ["ID", "NAME", "CODE", "PROPERTY_SITE_ROLE"]
        );
        while ($row = $res->GetNext()) {
            $sites[] = $row;
        }
        return $sites;
    }

    /** –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Ä—Ç–∞–ª –ø–æ –∫–æ–¥—É */
    public static function getSiteByCode(string $code): ?array
    {
        if (!Loader::includeModule('iblock')) {
            return null;
        }
        $IBLOCK_ID = self::getPortalIblockId();
        if ($IBLOCK_ID <= 0) {
            return null;
        }
        $row = \CIBlockElement::GetList(
            [],
            ["IBLOCK_ID" => $IBLOCK_ID, "=CODE" => $code, "ACTIVE" => "Y"],
            false, false,
            ["ID","NAME","CODE","PROPERTY_SITE_ROLE"]
        )->Fetch();
        return $row ?: null;
    }
}
