<?php
/**
 * Главная страница проекта SiteForge:
 * - Всем авторизованным: список подсайтов (через include).
 * - Только админам: форма создания + обработчик с PRG, чтобы F5 не дублировал создание.
 */

use Bitrix\Main\Loader;
use Bitrix\Main\Context;
use Local\Siteforge\SiteFactory;

require $_SERVER['DOCUMENT_ROOT'].'/bitrix/header.php';
$APPLICATION->SetTitle('SiteForge — список сайтов и создание');

/* ---------- Flash-сообщения после PRG-редиректа (публичные алерты) ---------- */
if (!isset($_SESSION)) { session_start(); }
?>
<style>
.sf-alert{margin:12px 0;padding:10px 12px;border-radius:8px}
.sf-alert-ok{background:#eef8f0;border:1px solid #bfe3c6;color:#1f7a33}
.sf-alert-err{background:#fff1f1;border:1px solid #f1c0c0;color:#a11}
</style>
<?php
if (!empty($_SESSION['SITEFORGE_SUCCESS'])) {
    echo '<div class="sf-alert sf-alert-ok">'.$_SESSION['SITEFORGE_SUCCESS'].'</div>';
    unset($_SESSION['SITEFORGE_SUCCESS']);
}
if (!empty($_SESSION['SITEFORGE_ERRORS']) && is_array($_SESSION['SITEFORGE_ERRORS'])) {
    foreach ($_SESSION['SITEFORGE_ERRORS'] as $err) {
        echo '<div class="sf-alert sf-alert-err">'.$err.'</div>';
    }
    unset($_SESSION['SITEFORGE_ERRORS']);
}
/* --------------------------------------------------------------------------- */

if (!Loader::includeModule('main')) {
    ShowError('Модуль main недоступен.');
    require $_SERVER['DOCUMENT_ROOT'].'/bitrix/footer.php';
    die();
}

require_once __DIR__.'/lib/SiteFactory.php';

global $USER;
if (!$USER->IsAuthorized()) {
    $APPLICATION->AuthForm('Пожалуйста, авторизуйтесь.');
}

$request = Context::getCurrent()->getRequest();
$factory = new SiteFactory();

/** ---------------- Обработчик формы (PRG) ---------------- */
if ($USER->IsAdmin() && $request->isPost() && check_bitrix_sessid()) {
    $siteName   = trim((string)$request->getPost('SITE_NAME'));
    $folderName = trim((string)$request->getPost('FOLDER_NAME'));
    $admins     = (array)$request->getPost('ADMINS');
    $users      = (array)$request->getPost('USERS');

    $errors = [];

    if ($siteName === '') {
        $errors[] = 'Заполните "Название сайта".';
    }
    if ($folderName === '' || !preg_match('~^[a-z0-9\-\_]+$~i', $folderName)) {
        $errors[] = 'Неверное "Название папки": допустимы латиница/цифры/-/_.';
    }
    $intersect = array_intersect((array)$admins, (array)$users);
    if (!empty($intersect)) {
        $errors[] = 'Пользователь не может одновременно быть админом и пользователем этого сайта.';
    }

    if (empty($errors)) {
        try {
            // 1) создать сайт
            $creation = $factory->createSite([
                'SITE_NAME'   => $siteName,
                'FOLDER_NAME' => $folderName,
            ]);
            // 2) группы
            $groupInfo = $factory->createGroupsAndAssignUsers([
                'SITE_CODE' => $creation['SITE_LID'],
                'ADMINS'    => $admins,
                'USERS'     => $users,
            ]);
            // 3) права
            $factory->applyFsPermissions([
                'FOLDER_ABS'     => $creation['FOLDER_ABS'],
                'ADMIN_GROUP_ID' => $groupInfo['ADMIN_GROUP_ID'],
                'USER_GROUP_ID'  => $groupInfo['USER_GROUP_ID'],
            ]);

            // Flash + PRG
            if (!isset($_SESSION)) { session_start(); }
            $_SESSION['SITEFORGE_SUCCESS'] = sprintf(
                'Сайт "%s" создан. Код (LID): %s. Папка: %s',
                htmlspecialcharsbx($siteName),
                htmlspecialcharsbx($creation['SITE_LID']),
                htmlspecialcharsbx($creation['FOLDER_ABS'])
            );
            LocalRedirect($APPLICATION->GetCurPageParam('', ['sessid'])); // редирект на GET
        } catch (\Throwable $e) {
            $errors[] = 'Ошибка: ' . htmlspecialcharsbx($e->getMessage());
        }
    }

    if (!empty($errors)) {
        if (!isset($_SESSION)) { session_start(); }
        $_SESSION['SITEFORGE_ERRORS'] = $errors;
        LocalRedirect($APPLICATION->GetCurPageParam('', ['sessid']));
    }
}
/** ---------------- /Обработчик формы (PRG) ---------------- */

// Данные для формы (только если админ)
$usersList = [];
if ($USER->IsAdmin()) {
    $rs = CUser::GetList($by='ID', $order='asc', ['ACTIVE'=>'Y'], ['FIELDS'=>['ID','NAME','LAST_NAME','LOGIN','EMAIL']]);
    while ($u = $rs->Fetch()) {
        $title = trim($u['LAST_NAME'].' '.$u['NAME']);
        if ($title === '') { $title = $u['LOGIN']; }
        $title .= ' ['.$u['ID'].']';
        if (!empty($u['EMAIL'])) { $title .= ' <'.$u['EMAIL'].'>'; }
        $usersList[] = ['ID'=>$u['ID'], 'TITLE'=>$title];
    }
}
?>
<style>
.sf-container {max-width:1100px;margin:0 auto;padding:8px 0;}
.sf-form {margin:18px 0;padding:16px;border:1px dashed #cfd6de;border-radius:10px;background:#fafcff;}
.sf-form h3 {margin:0 0 8px 0;}
.sf-form .row {margin:10px 0;}
</style>

<div class="sf-container">
    <h2 style="margin:8px 0 12px">Сайты SiteForge</h2>

    <?php require $_SERVER['DOCUMENT_ROOT'].'/local/siteforge/include/siteforge.sites.php'; ?>

    <?php if ($USER->IsAdmin()): ?>
        <div class="sf-form">
            <h3>Создать новый сайт</h3>
            <form method="post" action="">
                <?= bitrix_sessid_post() ?>

                <div class="row">
                    <label><b>Название сайта</b></label><br>
                    <input type="text" name="SITE_NAME" value="<?=htmlspecialcharsbx($request->getPost('SITE_NAME'))?>" style="width:100%;max-width:520px">
                </div>

                <div class="row">
                    <label><b>Название папки</b> <small>/local/siteforge/<u>ваша_папка</u></small></label><br>
                    <input type="text" name="FOLDER_NAME" value="<?=htmlspecialcharsbx($request->getPost('FOLDER_NAME'))?>" style="width:100%;max-width:320px">
                </div>

                <div class="row" style="display:flex;gap:24px;flex-wrap:wrap">
                    <div>
                        <div>Администраторы сайта:</div>
                        <select name="ADMINS[]" multiple size="10" style="min-width:360px">
                            <?php foreach ($usersList as $u): ?>
                                <option value="<?=$u['ID']?>" <?=(in_array($u['ID'], (array)$request->getPost('ADMINS') ?? [], true) ? 'selected' : '')?>>
                                    <?=htmlspecialcharsbx($u['TITLE'])?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div>
                        <div>Пользователи сайта:</div>
                        <select name="USERS[]" multiple size="10" style="min-width:360px">
                            <?php foreach ($usersList as $u): ?>
                                <option value="<?=$u['ID']?>" <?=(in_array($u['ID'], (array)$request->getPost('USERS') ?? [], true) ? 'selected' : '')?>>
                                    <?=htmlspecialcharsbx($u['TITLE'])?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <button type="submit" class="ui-btn ui-btn-primary">Создать сайт</button>
                </div>
            </form>
        </div>
    <?php endif; ?>
</div>

<?php
require $_SERVER['DOCUMENT_ROOT'].'/bitrix/footer.php';
