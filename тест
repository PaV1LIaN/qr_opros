<?php
require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/header.php");

use Bitrix\Main\Context;

require_once $_SERVER["DOCUMENT_ROOT"] . "/local/typical_sites/lib/SiteService.php";

global $USER;
$APPLICATION->SetTitle("Типовой сайт");

$request = Context::getCurrent()->getRequest();
$code = trim((string)$request->getQuery("code"));

if ($code === '') {
    ShowError("Код сайта не указан.");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

if (!$USER->IsAuthorized()) {
    ShowError("Требуется авторизация.");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

$service = new \Cc10\SiteService();

$site = $service->getSiteByCode($code);
if (!$site) {
    ShowError("Сайт не найден или не активен.");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

$role = $service->getUserRole((int)$USER->GetID(), (int)$site['ID']);
if (!$role) {
    ShowError("У вас нет доступа к этому сайту.");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

/**
 * 1) ПРИОРИТЕТ: файловая реализация сайта
 * Если есть /local/typical_sites/sites/<code>/index.php — рендерим его.
 */
$siteFolder = $_SERVER["DOCUMENT_ROOT"] . '/local/typical_sites/sites/' . $code . '/';
$fileIndex = $siteFolder . 'index.php';

if (file_exists($fileIndex)) {
    // Можно передать переменные в файловый шаблон:
    $TS_SITE = $site;
    $TS_ROLE = $role;

    include $fileIndex;

    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

/**
 * 2) ИНАЧЕ: HL-страницы SitePages
 */
try {
    $service->ensureDefaultPages((int)$site['ID']);

    $pages = $service->getPagesForSite((int)$site['ID']);

    $pageSlug = trim((string)$request->getQuery('page'));
    if ($pageSlug === '') {
        $pageSlug = 'index';
    }

    $page = $service->getPageBySlug((int)$site['ID'], $pageSlug);

    if (!$page && !empty($pages)) {
        $page = $pages[0];
        $pageSlug = (string)$page['UF_SLUG'];
    }
} catch (\Throwable $e) {
    ShowError("Ошибка загрузки страниц: " . $e->getMessage());
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

// Вывод HL-страниц
echo '<h1>' . htmlspecialcharsbx((string)$site['UF_NAME']) . '</h1>';

if (!empty($pages)) {
    echo '<nav style="margin:10px 0; padding:10px; border:1px solid #ddd;">';

    foreach ($pages as $p) {
        $slug  = (string)$p['UF_SLUG'];
        $title = (string)$p['UF_TITLE'];

        $url = '/local/typical_sites/site.php?code=' . urlencode((string)$site['UF_CODE']) . '&page=' . urlencode($slug);

        $style = ($slug === $pageSlug)
            ? 'font-weight:bold; text-decoration:underline; margin-right:12px;'
            : 'margin-right:12px;';

        echo '<a style="' . $style . '" href="' . htmlspecialcharsbx($url) . '">'
            . htmlspecialcharsbx($title)
            . '</a>';
    }

    echo '</nav>';
}

if ($page) {
    echo '<h2>' . htmlspecialcharsbx((string)$page['UF_TITLE']) . '</h2>';
    echo '<div class="ts-content" style="padding:10px; border:1px solid #eee;">' . (string)$page['UF_CONTENT'] . '</div>';
} else {
    echo '<p>Страницы не найдены.</p>';
}

require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
