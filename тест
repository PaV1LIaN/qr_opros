<?php
require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/header.php");

use Bitrix\Main\Context;

require_once $_SERVER["DOCUMENT_ROOT"] . "/local/typical_sites/lib/SiteService.php";

global $USER, $APPLICATION;

$request = Context::getCurrent()->getRequest();

$code = trim((string)$request->getQuery('code'));
if ($code === '') {
    ShowError("Не указан code");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

if (!$USER->IsAuthorized()) {
    ShowError("Требуется авторизация");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

$service = new \Cc10\SiteService();

$site = $service->getSiteByCode($code);
if (!$site) {
    ShowError("Сайт не найден или не активен");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

$siteId = (int)$site['ID'];
$role = $service->getUserRole((int)$USER->GetID(), $siteId);

if (!$USER->IsAdmin() && !in_array($role, ['ADMIN', 'DEVELOPER'], true)) {
    ShowError("Нет прав на просмотр логов");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

$APPLICATION->SetTitle("Логи: " . (string)$site['UF_NAME']);

// фильтр по action
$action = strtoupper(trim((string)$request->getQuery('action')));

// пагинация
$page = max(1, (int)$request->getQuery('p'));
$limit = 50;
$offset = ($page - 1) * $limit;

// данные
$total = $service->getAuditCountForSiteFiltered($siteId, $action);
$rows  = $service->getAuditForSiteFiltered($siteId, $action, $limit, $offset);
$actionsAll = $service->getAuditActionsForSite($siteId);

// соберём userIds
$userIds = [];
foreach ($rows as $r) {
    $uid = (int)($r['UF_USER'] ?? 0);
    if ($uid > 0) $userIds[$uid] = true;
}

// мапа userId -> ФИО/логин
$userMap = [];
if (!empty($userIds)) {
    $ids = array_keys($userIds);

    $rsUsers = \CUser::GetList(
        ($by = "id"),
        ($order = "asc"),
        ['ID' => implode('|', $ids)],
        ['FIELDS' => ['ID', 'NAME', 'LAST_NAME', 'SECOND_NAME', 'LOGIN', 'EMAIL']]
    );

    while ($u = $rsUsers->Fetch()) {
        $full = trim(
            ($u['LAST_NAME'] ?? '') . ' ' .
            ($u['NAME'] ?? '') . ' ' .
            ($u['SECOND_NAME'] ?? '')
        );

        if ($full === '') {
            $full = (string)($u['LOGIN'] ?? ('user#' . $u['ID']));
        }

        $userMap[(int)$u['ID']] = $full;
    }
}

$totalPages = max(1, (int)ceil($total / $limit));

function ts_build_audit_url(string $code, int $p, string $action): string
{
    $url = '/local/typical_sites/audit.php?code=' . urlencode($code) . '&p=' . $p;
    if ($action !== '') {
        $url .= '&action=' . urlencode($action);
    }
    return $url;
}
?>

<h1>Логи: <?= htmlspecialcharsbx((string)$site['UF_NAME']) ?></h1>

<p>
    <a href="/local/typical_sites/site.php?code=<?= urlencode($code) ?>">← Назад к сайту</a>
</p>

<form method="get" style="margin:10px 0; padding:10px; border:1px solid #ddd;">
    <input type="hidden" name="code" value="<?= htmlspecialcharsbx($code) ?>">
    <label>Фильтр по ACTION:</label>
    <select name="action">
        <option value="">(все)</option>
        <?php foreach ($actionsAll as $a): ?>
            <option value="<?= htmlspecialcharsbx($a) ?>" <?= ($action === $a ? 'selected' : '') ?>>
                <?= htmlspecialcharsbx($a) ?>
            </option>
        <?php endforeach; ?>
    </select>
    <button type="submit">Применить</button>
</form>

<p>Всего записей: <?= (int)$total ?></p>

<?php if (empty($rows)): ?>
    <p>Логов пока нет (или не найдено по фильтру).</p>
<?php else: ?>
    <table border="1" cellpadding="6" cellspacing="0" style="width:100%;">
        <tr>
            <th>ID</th>
            <th>Когда</th>
            <th>Кто</th>
            <th>Action</th>
            <th>Entity</th>
            <th>Entity ID</th>
            <th>Data</th>
        </tr>

        <?php foreach ($rows as $r): ?>
            <?php
            $uid = (int)($r['UF_USER'] ?? 0);
            $who = $uid > 0 ? ($userMap[$uid] ?? ('user#' . $uid)) : '-';

            $data = (string)($r['UF_DATA'] ?? '');
            $dataShort = $data;
            if (mb_strlen($dataShort) > 400) {
                $dataShort = mb_substr($dataShort, 0, 400) . '...';
            }
            ?>
            <tr>
                <td><?= (int)$r['ID'] ?></td>
                <td><?= htmlspecialcharsbx((string)$r['UF_CREATED_AT']) ?></td>
                <td><?= htmlspecialcharsbx($who) ?></td>
                <td><?= htmlspecialcharsbx((string)$r['UF_ACTION']) ?></td>
                <td><?= htmlspecialcharsbx((string)$r['UF_ENTITY']) ?></td>
                <td><?= (int)$r['UF_ENTITY_ID'] ?></td>
                <td>
                    <pre style="white-space:pre-wrap; margin:0;"><?= htmlspecialcharsbx($dataShort) ?></pre>
                </td>
            </tr>
        <?php endforeach; ?>
    </table>

    <?php if ($totalPages > 1): ?>
        <div style="margin-top:12px;">
            <?php for ($i = 1; $i <= $totalPages; $i++): ?>
                <?php $url = ts_build_audit_url($code, $i, $action); ?>
                <?php if ($i === $page): ?>
                    <strong style="margin-right:8px;"><?= $i ?></strong>
                <?php else: ?>
                    <a style="margin-right:8px;" href="<?= htmlspecialcharsbx($url) ?>"><?= $i ?></a>
                <?php endif; ?>
            <?php endfor; ?>
        </div>
    <?php endif; ?>
<?php endif; ?>

<?php require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php"); ?>
