<?php
if (!defined("B_PROLOG_INCLUDED") || B_PROLOG_INCLUDED !== true) die();
global $USER;

use Bitrix\Main\UI\Extension;

Extension::load(['ui.entity-selector', 'ui.buttons', 'ui.alerts', 'main.core']);
?>

<?php if ($USER->IsAdmin()): ?>

<style>
.portal-form-card {
    background: #fff;
    border: 1px solid #e3e7ec;
    border-radius: 12px;
    padding: 24px;
    margin: 20px 0 32px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    transition: box-shadow 0.2s ease, border 0.2s ease;
}
.portal-form-card:hover {
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    border-color: #dce2eb;
}
.portal-form-card h3 {
    margin-top: 0;
    font-size: 19px;
    font-weight: 600;
    margin-bottom: 20px;
}
.portal-form-field {
    margin-bottom: 16px;
}
.portal-form-label {
    display: block;
    font-weight: 500;
    margin-bottom: 6px;
    color: #333;
}
.portal-form-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #dce2eb;
    border-radius: 6px;
    font-size: 14px;
    line-height: 1.4;
    transition: border-color 0.2s ease;
}
.portal-form-input:focus {
    border-color: #0065ff;
    outline: none;
}
.portal-users-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
}
</style>

<div class="portal-form-card">
    <h3>Создать новый сайт</h3>

    <form method="POST" action="">
        <?= bitrix_sessid_post() ?>
        <input type="hidden" name="create_site" value="Y">

        <div class="portal-form-field">
            <label class="portal-form-label">Название сайта</label>
            <input type="text" name="site_title" class="portal-form-input" placeholder="Например: Отдел продаж" required>
        </div>

        <div class="portal-form-field">
            <label class="portal-form-label">Код сайта (латиницей, без пробелов)</label>
            <input type="text" name="site_code" class="portal-form-input" placeholder="sales" required>
        </div>

        <div class="portal-form-field">
            <label class="portal-form-label">Название роли / группы пользователей</label>
            <input type="text" name="role_name" class="portal-form-input" placeholder="Сотрудники отдела продаж" required>
        </div>

        <div class="portal-form-field">
            <label class="portal-form-label">Пользователи роли</label>
            <div id="user-selector-container" class="portal-users-list"></div>
            <input type="hidden" name="role_users" id="role-users-input" value="">
            <button type="button" id="select-users-btn" class="ui-btn ui-btn-light-border ui-btn-sm" style="margin-top:6px;">
                Выбрать пользователей
            </button>
        </div>

        <div style="margin-top:24px;">
            <button type="submit" class="ui-btn ui-btn-success">Создать сайт</button>
        </div>
    </form>
</div>

<script>
BX.ready(function () {
    const container = document.getElementById('user-selector-container');
    const input = document.getElementById('role-users-input');
    const btn = document.getElementById('select-users-btn');
    let selectedUsers = [];

    function renderUsers(users) {
        container.innerHTML = '';
        users.forEach(u => {
            const el = document.createElement('div');
            el.className = 'ui-label ui-label-light ui-label-fill-light';
            el.style.display = 'flex';
            el.style.alignItems = 'center';
            el.style.gap = '6px';
            el.style.margin = '4px';
            el.innerHTML =
                (u.avatar
                    ? '<img src="' + BX.util.htmlspecialchars(u.avatar) + '" style="width:24px; height:24px; border-radius:50%; object-fit:cover;">'
                    : '<div style="width:24px; height:24px; border-radius:50%; background:#e1e5eb; display:flex; align-items:center; justify-content:center; font-size:11px; color:#555;">' + (u.title ? u.title.charAt(0).toUpperCase() : '?') + '</div>'
                ) +
                '<span class="ui-label-inner">' + BX.util.htmlspecialchars(u.title) + '</span>';
            container.appendChild(el);
        });
    }

    btn.addEventListener('click', function () {
        const dialog = new BX.UI.EntitySelector.Dialog({
            id: 'portal-hub-create-role',
            context: 'PORTAL_HUB_CREATE_ROLE',
            targetNode: btn,
            entities: [{ id: 'user' }],
            multiple: true,
            enableSearch: true,
            width: 500,
            dropdownMode: false,
            selectedItems: selectedUsers.map(u => ({ entityId: 'user', id: String(u.id) })),
            events: {
                'Item:onSelect': updateView,
                'Item:onDeselect': updateView
            }
        });

        function updateView() {
            const items = dialog.getSelectedItems();
            selectedUsers = items.map(i => ({
                id: i.id,
                title: i.getTitle(),
                avatar: i.getAvatar()
            }));
            renderUsers(selectedUsers);
            input.value = selectedUsers.map(u => u.id).join(',');
        }

        dialog.subscribe('onHide', function () {
            const items = dialog.getSelectedItems();
            selectedUsers = items.map(i => ({
                id: i.id,
                title: i.getTitle(),
                avatar: i.getAvatar()
            }));
            renderUsers(selectedUsers);
            input.value = selectedUsers.map(u => u.id).join(',');
        });

        dialog.show();
    });
});
</script>

<?php endif; ?>
