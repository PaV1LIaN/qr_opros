<?php
// Подключаем jQuery и Select2
?>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<h2>Список сайтов</h2>
<ul>
<?php foreach ($sites as $site): ?>
    <li style="margin-bottom: 20px;">
        <a href="/local/portal_hub/sites/<?=$site["CODE"]?>/" target="_blank">
            <?=$site["NAME"]?>
        </a>

        <?php if ($USER->IsAdmin() && (int)$site["ROLE_ID"]): ?>
            <?php
            // Текущие пользователи роли
            $labels = [];
            $currentIds = [];
            $rsU = \CUser::GetList($by="id", $order="asc", ["GROUPS_ID"=>[(int)$site["ROLE_ID"]]]);
            while ($u = $rsU->Fetch()) {
                $labels[] = "✅ ".trim($u["NAME"]." ".$u["LAST_NAME"]);
                $currentIds[] = (int)$u["ID"];
            }
            ?>
            <div id="access-view-<?=$site["ID"]?>" style="margin-left:20px;">
                <strong>Пользователи:</strong> <?= $labels ? implode(", ", $labels) : "никто" ?>
            </div>

            <button type="button" onclick="document.getElementById('edit-<?=$site["ID"]?>').style.display='block'">
                Изменить доступ
            </button>

            <div id="edit-<?=$site["ID"]?>" style="display:none; margin-top:10px;">
                <form onsubmit="return updateAccess<?=$site["ID"]?>(this)">
                    <input type="hidden" name="ROLE_ID" value="<?=$site["ROLE_ID"]?>">

                    <h4>Выберите пользователей:</h4>
                    <select name="SITE_USERS[]" multiple id="user-select-<?=$site["ID"]?>" style="width:320px;">
                        <?php
                        $rsAllUsers = \CUser::GetList($by="id", $order="asc", ["ACTIVE"=>"Y"]);
                        while ($user = $rsAllUsers->Fetch()):
                            $uid = (int)$user["ID"];
                            $label = trim($user["NAME"]." ".$user["LAST_NAME"]);
                            if ($label === "") $label = $user["LOGIN"];
                            $selected = in_array($uid, $currentIds, true) ? "selected" : "";
                        ?>
                            <option value="<?=$uid?>" <?=$selected?>><?=$label?></option>
                        <?php endwhile; ?>
                    </select>

                    <br><br>
                    <button type="submit">Сохранить</button>
                    <button type="button" onclick="document.getElementById('edit-<?=$site["ID"]?>').style.display='none'">Отмена</button>
                </form>
            </div>

            <script>
            $(document).ready(function() {
                // инициализация Select2 для конкретного списка
                $("#user-select-<?=$site["ID"]?>").select2({
                    placeholder: "Выберите пользователей",
                    allowClear: true,
                    width: "resolve"
                });
            });

            function updateAccess<?=$site["ID"]?>(form) {
                const formData = new FormData(form);
                formData.append("AJAX", "UPDATE_ROLE");

                fetch("<?=$APPLICATION->GetCurPage()?>", {
                    method: "POST",
                    body: formData,
                    headers: { "X-Requested-With": "XMLHttpRequest" }
                })
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        document.querySelector("#access-view-<?=$site["ID"]?>").innerHTML =
                            "<strong>Пользователи:</strong> " + res.labels.join(", ");
                        document.getElementById("edit-<?=$site["ID"]?>").style.display = "none";
                    } else {
                        alert("Ошибка сохранения");
                    }
                })
                .catch(err => alert("AJAX error: " + err));

                return false;
            }
            </script>
        <?php endif; ?>
    </li>
<?php endforeach; ?>
</ul>
