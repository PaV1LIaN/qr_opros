<?php
if (!defined("B_PROLOG_INCLUDED") || B_PROLOG_INCLUDED !== true) die();

\Bitrix\Main\UI\Extension::load("ui.entity-selector");
?>

<?php if (!empty($arResult['ERRORS'])): ?>
    <div style="color:red;">
        <?php foreach ($arResult['ERRORS'] as $error): ?>
            <div><?= htmlspecialcharsbx($error) ?></div>
        <?php endforeach; ?>
    </div>
<?php endif; ?>

<form method="post" id="ts-form">
    <?= bitrix_sessid_post() ?>

    <div>
        <label>Название сайта:</label><br>
        <input type="text" name="NAME" value="<?= htmlspecialcharsbx($_POST['NAME'] ?? '') ?>">
    </div>

    <div style="margin-top:10px;">
        <label>Код сайта (URL):</label><br>
        <input type="text" name="CODE" value="<?= htmlspecialcharsbx($_POST['CODE'] ?? '') ?>">
        <small>Например: training-portal</small>
    </div>

    <div style="margin-top:12px;">
        <label>Пользователи (VIEWERS):</label><br>
        <div id="ts-viewers"></div>
        <div id="ts-viewers-inputs"></div>
    </div>

    <div style="margin-top:12px;">
        <label>Администраторы (ADMINS):</label><br>
        <div id="ts-admins"></div>
        <div id="ts-admins-inputs"></div>
    </div>

    <div style="margin-top:15px;">
        <button type="submit">Создать сайт</button>
    </div>
</form>

<script>
BX.ready(function () {
  function buildHiddenInputs(selector, inputsContainerId, inputName) {
    const container = document.getElementById(inputsContainerId);
    container.innerHTML = "";

    // getTags() — штатный метод TagSelector :contentReference[oaicite:1]{index=1}
    const tags = selector.getTags();

    tags.forEach(tag => {
      // TagItem содержит id + entityId (user/department/etc)
      const entityId = tag.getEntityId ? tag.getEntityId() : null;
      const rawId = tag.getId ? tag.getId() : null;

      if (entityId !== "user") return;

      const id = parseInt(rawId, 10);
      if (!id) return;

      const input = document.createElement("input");
      input.type = "hidden";
      input.name = inputName + "[]";
      input.value = id;
      container.appendChild(input);
    });
  }

  function makeSelector(renderNodeId, inputsNodeId, inputName, context) {
    const selector = new BX.UI.EntitySelector.TagSelector({
      id: renderNodeId,
      // multiple по умолчанию true, но оставим явно :contentReference[oaicite:2]{index=2}
      multiple: true,
      dialogOptions: {
        context: context,
        entities: [{ id: "user" }],
        // на всякий случай (в разных сборках бывает полезно)
        multiple: true,
        enableSearch: true
      },
      events: {
        onAfterTagAdd: () => buildHiddenInputs(selector, inputsNodeId, inputName),
        onAfterTagRemove: () => buildHiddenInputs(selector, inputsNodeId, inputName),
      }
    });

    selector.renderTo(document.getElementById(renderNodeId));
    buildHiddenInputs(selector, inputsNodeId, inputName);

    return selector;
  }

  const viewersSelector = makeSelector("ts-viewers", "ts-viewers-inputs", "VIEWERS", "TYPICAL_SITES_VIEWERS");
  const adminsSelector  = makeSelector("ts-admins",  "ts-admins-inputs",  "ADMINS",  "TYPICAL_SITES_ADMINS");

  // На submit ещё раз синхронизируем hidden-поля
  document.getElementById("ts-form").addEventListener("submit", function () {
    buildHiddenInputs(viewersSelector, "ts-viewers-inputs", "VIEWERS");
    buildHiddenInputs(adminsSelector,  "ts-admins-inputs",  "ADMINS");
  });
});
</script>
