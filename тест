<?php
if (!defined("B_PROLOG_INCLUDED") || B_PROLOG_INCLUDED !== true) die();

use Bitrix\Main\UI\Extension;
Extension::load(['ui.entity-selector', 'ui.forms', 'ui.buttons']);
?>

<form method="post" style="margin-top:20px;">
    <?= bitrix_sessid_post() ?>
    <input type="hidden" name="create_site" value="Y">

    <table class="adm-detail-content-table edit-table" style="width:60%;">
        <tr>
            <td width="40%">Название сайта:</td>
            <td><input type="text" name="site_title" size="40" required></td>
        </tr>
        <tr>
            <td>Код сайта (папка):</td>
            <td><input type="text" name="site_code" size="40" required></td>
        </tr>
        <tr>
            <td>Название роли:</td>
            <td><input type="text" name="role_name" size="40" required></td>
        </tr>
        <tr>
            <td>Администраторы сайта:</td>
            <td>
                <input type="hidden" name="role_users" id="role_users_input">
                <div id="role_users_selector"></div>
            </td>
        </tr>
        <tr>
            <td>Обычные пользователи:</td>
            <td>
                <input type="hidden" name="site_users" id="site_users_input">
                <div id="site_users_selector"></div>
            </td>
        </tr>
        <tr>
            <td></td>
            <td>
                <button type="submit" class="ui-btn ui-btn-primary">Создать сайт</button>
            </td>
        </tr>
    </table>
</form>

<script>
BX.ready(function() {
    const adminDialog = new BX.UI.EntitySelector.Dialog({
        id: 'portal_admins_create',
        context: 'PORTAL_CREATE',
        targetNode: document.getElementById('role_users_selector'),
        entities: [{ id: 'user' }],
        multiple: true,
        enableSearch: true,
        events: { 'Item:onSelect': updateAdmins, 'Item:onDeselect': updateAdmins }
    });

    const userDialog = new BX.UI.EntitySelector.Dialog({
        id: 'portal_users_create',
        context: 'PORTAL_CREATE',
        targetNode: document.getElementById('site_users_selector'),
        entities: [{ id: 'user' }],
        multiple: true,
        enableSearch: true,
        events: { 'Item:onSelect': updateUsers, 'Item:onDeselect': updateUsers }
    });

    function updateAdmins() {
        const ids = adminDialog.getSelectedItems().map(i => i.id);
        document.getElementById('role_users_input').value = ids.join(',');
    }

    function updateUsers() {
        const ids = userDialog.getSelectedItems().map(i => i.id);
        document.getElementById('site_users_input').value = ids.join(',');
    }

    adminDialog.renderTo(document.getElementById('role_users_selector'));
    userDialog.renderTo(document.getElementById('site_users_selector'));
});
</script>
