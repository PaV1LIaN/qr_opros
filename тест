<?php
require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/header.php");
$APPLICATION->SetAdditionalCSS("/local/typical_sites/assets/style.css");

use Bitrix\Main\Context;

require_once $_SERVER["DOCUMENT_ROOT"] . "/local/typical_sites/lib/SiteService.php";

global $USER, $APPLICATION;

$request = Context::getCurrent()->getRequest();

$code = trim((string)$request->getQuery('code'));
if ($code === '') {
    ShowError("Не указан code");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

if (!$USER->IsAuthorized()) {
    ShowError("Требуется авторизация");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

$service = new \Cc10\SiteService();
$site = $service->getSiteByCode($code);

if (!$site) {
    ShowError("Сайт не найден или не активен");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

$siteId = (int)$site['ID'];
$role = $service->getUserRole((int)$USER->GetID(), $siteId);

if (!$USER->IsAdmin() && !in_array($role, ['ADMIN', 'DEVELOPER'], true)) {
    ShowError("Нет прав на управление страницами");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

$APPLICATION->SetTitle("Страницы: " . (string)$site['UF_NAME']);

$errors = [];

// действия: удалить/восстановить (если у тебя soft delete уже внедрён)
if ($request->isPost() && check_bitrix_sessid()) {
    $action = (string)$request->getPost('action');
    $pageId = (int)$request->getPost('page_id');

    try {
        if ($pageId > 0 && $action === 'delete') {
            // если у тебя нет softDeletePage — замени на deletePage (но лучше soft)
            if (method_exists($service, 'softDeletePage')) {
                $service->softDeletePage($pageId, $siteId, (int)$USER->GetID());
                $service->logAction($siteId, (int)$USER->GetID(), 'PAGE_DELETE', 'page', $pageId, ['soft' => true]);
            } else {
                $service->deletePage($pageId, $siteId);
                $service->logAction($siteId, (int)$USER->GetID(), 'PAGE_DELETE', 'page', $pageId, ['soft' => false]);
            }
        } elseif ($pageId > 0 && $action === 'restore') {
            if (method_exists($service, 'restorePage')) {
                $service->restorePage($pageId, $siteId);
                $service->logAction($siteId, (int)$USER->GetID(), 'PAGE_RESTORE', 'page', $pageId, []);
            }
        }

        LocalRedirect('/local/typical_sites/pages.php?code=' . urlencode($code));
    } catch (\Throwable $e) {
        $errors[] = $e->getMessage();
    }
}

$pages = $service->getPagesForSite($siteId, true);
?>

<div class="ts-wrap">

  <div class="ts-header">
    <h1 class="ts-title">Страницы: <?= htmlspecialcharsbx((string)$site['UF_NAME']) ?></h1>
    <div class="ts-row">
      <a class="ts-btn" href="/local/typical_sites/site.php?code=<?= urlencode($code) ?>" target="_blank">Открыть сайт</a>
      <a class="ts-btn" href="/local/typical_sites/page_edit.php?code=<?= urlencode($code) ?>">+ Создать страницу</a>
    </div>
  </div>

  <div class="ts-nav">
    <a href="/local/typical_sites/admin.php">Сайты</a>
    <a href="/local/typical_sites/pages.php?code=<?= urlencode($code) ?>">Страницы</a>
    <a href="/local/typical_sites/access_manage.php?code=<?= urlencode($code) ?>">Доступы</a>
    <a href="/local/typical_sites/audit.php?code=<?= urlencode($code) ?>">Логи</a>
    <a href="/local/typical_sites/settings.php?code=<?= urlencode($code) ?>">Настройки</a>
  </div>

  <div class="ts-card">
    <div class="ts-row">
      <label>Поиск:</label>
      <input class="ts-input" type="text" id="ts-search" placeholder="Заголовок или SLUG..." style="width:300px;">
      <span class="ts-badge" id="ts-count"><?= count($pages) ?></span>
    </div>
  </div>

  <?php if (!empty($errors)): ?>
    <div class="ts-error ts-card">
      <?php foreach ($errors as $e): ?>
        <div><?= htmlspecialcharsbx($e) ?></div>
      <?php endforeach; ?>
    </div>
  <?php endif; ?>

  <?php if (empty($pages)): ?>
    <div class="ts-card">Страниц пока нет.</div>
  <?php else: ?>
    <div class="ts-card">
      <table class="ts-table">
        <thead>
          <tr>
            <th style="width:70px;">ID</th>
            <th>Заголовок</th>
            <th style="width:180px;">SLUG</th>
            <th style="width:80px;">SORT</th>
            <th style="width:90px;">Активна</th>
            <th style="width:320px;">Действия</th>
          </tr>
        </thead>
        <tbody>
          <?php foreach ($pages as $p): ?>
            <?php
              $slug = (string)$p['UF_SLUG'];
              $isActive = !empty($p['UF_ACTIVE']);
              $openUrl = '/local/typical_sites/site.php?code=' . urlencode($code) . '&page=' . urlencode($slug);
              $searchKey = mb_strtolower(trim((string)$p['UF_TITLE'] . ' ' . $slug));
            ?>
            <tr class="ts-page-row" data-search="<?= htmlspecialcharsbx($searchKey) ?>">
              <td><?= (int)$p['ID'] ?></td>
              <td><?= htmlspecialcharsbx((string)$p['UF_TITLE']) ?></td>
              <td><span class="ts-badge"><?= htmlspecialcharsbx($slug) ?></span></td>
              <td><?= (int)$p['UF_SORT'] ?></td>
              <td>
                <?php if ($isActive): ?>
                  <span class="ts-badge ts-badge-ok">Y</span>
                <?php else: ?>
                  <span class="ts-badge ts-badge-off">N</span>
                <?php endif; ?>
              </td>
              <td>
                <a class="ts-btn" href="/local/typical_sites/page_edit.php?code=<?= urlencode($code) ?>&page_id=<?= (int)$p['ID'] ?>">Редактировать</a>
                <a class="ts-btn" href="/local/typical_sites/blocks.php?code=<?= urlencode($code) ?>&page_id=<?= (int)$p['ID'] ?>">Блоки</a>
                <a class="ts-btn" href="<?= htmlspecialcharsbx($openUrl) ?>" target="_blank">Открыть</a>

                <form method="post" style="display:inline;" onsubmit="return confirm('Удалить страницу?');">
                  <?= bitrix_sessid_post() ?>
                  <input type="hidden" name="page_id" value="<?= (int)$p['ID'] ?>">
                  <button class="ts-btn ts-btn-danger" type="submit" name="action" value="delete">Удалить</button>
                </form>
              </td>
            </tr>
          <?php endforeach; ?>
        </tbody>
      </table>
    </div>
  <?php endif; ?>

</div>

<script>
(function(){
  const input = document.getElementById('ts-search');
  const rows = document.querySelectorAll('.ts-page-row');
  const badge = document.getElementById('ts-count');

  function apply(){
    const q = (input.value || '').toLowerCase().trim();
    let shown = 0;
    rows.forEach(r => {
      const key = (r.getAttribute('data-search') || '');
      const ok = (q === '' || key.includes(q));
      r.style.display = ok ? '' : 'none';
      if (ok) shown++;
    });
    if (badge) badge.textContent = shown;
  }

  if (input) input.addEventListener('input', apply);
})();
</script>

<?php
require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
