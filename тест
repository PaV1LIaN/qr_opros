<?php
require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/header.php");

use Bitrix\Main\Context;
use Bitrix\Main\Loader;

require_once $_SERVER["DOCUMENT_ROOT"] . "/local/typical_sites/lib/SiteService.php";

global $USER, $APPLICATION;

$request = Context::getCurrent()->getRequest();

$code = trim((string)$request->getQuery('code'));
$pageId = (int)$request->getQuery('page_id');
$blockId = (int)$request->getQuery('block_id');

if ($code === '' || $pageId <= 0) {
    ShowError("Не указан code или page_id");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

if (!$USER->IsAuthorized()) {
    ShowError("Требуется авторизация");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

$service = new \Cc10\SiteService();

$site = $service->getSiteByCode($code);
if (!$site) {
    ShowError("Сайт не найден или не активен");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

$siteId = (int)$site['ID'];
$role = $service->getUserRole((int)$USER->GetID(), $siteId);

if (!$USER->IsAdmin() && !in_array($role, ['ADMIN','DEVELOPER'], true)) {
    ShowError("Нет прав на редактирование блоков");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

$page = $service->getPageById($pageId);
if (!$page || (int)$page['UF_SITE'] !== $siteId) {
    ShowError("Страница не найдена или не принадлежит этому сайту");
    require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
    exit;
}

$errors = [];
$block = null;

if ($blockId > 0) {
    $block = $service->getBlockById($blockId);
    if (!$block) {
        $errors[] = "Блок не найден";
        $blockId = 0;
    } elseif ((int)$block['UF_SITE'] !== $siteId || (int)$block['UF_PAGE'] !== (int)$page['ID']) {
        $errors[] = "Блок не принадлежит этой странице/сайту";
        $block = null;
        $blockId = 0;
    }
}

$settings = $block ? $service->decodeSettings((string)$block['UF_SETTINGS']) : [];

if ($request->isPost() && check_bitrix_sessid()) {
    $type = strtoupper(trim((string)$request->getPost('TYPE')));
    $title = (string)$request->getPost('TITLE');
    $sort = (int)$request->getPost('SORT');
    $active = ($request->getPost('ACTIVE') === 'Y');

    try {
        // SETTINGS по типу
        if ($type === 'TEXT') {
            $html = (string)$request->getPost('TEXT_HTML');
            $set = ['html' => $html];

        } elseif ($type === 'IFRAME') {
            $url = trim((string)$request->getPost('IFRAME_URL'));
            $height = (int)$request->getPost('IFRAME_HEIGHT');
            if ($height <= 200) $height = 600;

            $set = ['url' => $url, 'height' => $height];

        } elseif ($type === 'LINK') {
            $url = trim((string)$request->getPost('LINK_URL'));
            $label = trim((string)$request->getPost('LINK_LABEL'));
            if ($label === '') $label = 'Открыть';

            $set = ['url' => $url, 'label' => $label];

        } else {
            throw new \InvalidArgumentException("Неизвестный TYPE");
        }

        if ($blockId > 0) {
            $service->updateBlock($blockId, $siteId, (int)$page['ID'], [
                'TYPE' => $type,
                'TITLE' => $title,
                'SORT' => $sort,
                'ACTIVE' => $active,
                'SETTINGS' => $set,
            ]);

            // Audit
            $service->logAction($siteId, (int)$USER->GetID(), 'BLOCK_UPDATE', 'block', $blockId, [
                'page_id' => (int)$page['ID'],
                'type' => $type,
                'title' => $title,
                'sort' => $sort,
                'active' => $active,
            ]);

        } else {
            $newBlockId = $service->addBlock($siteId, (int)$page['ID'], [
                'TYPE' => $type,
                'TITLE' => $title,
                'SORT' => $sort,
                'ACTIVE' => $active,
                'SETTINGS' => $set,
            ]);

            // Audit
            $service->logAction($siteId, (int)$USER->GetID(), 'BLOCK_CREATE', 'block', $newBlockId, [
                'page_id' => (int)$page['ID'],
                'type' => $type,
                'title' => $title,
                'sort' => $sort,
                'active' => $active,
            ]);
        }

        LocalRedirect('/local/typical_sites/blocks.php?code=' . urlencode($code) . '&page_id=' . (int)$page['ID']);
    } catch (\Throwable $e) {
        $errors[] = $e->getMessage();
    }
}

// значения формы (учитываем POST при ошибке)
$typeValue = $_POST['TYPE'] ?? ($block['UF_TYPE'] ?? 'TEXT');
$titleValue = $_POST['TITLE'] ?? ($block['UF_TITLE'] ?? '');
$sortValue = $_POST['SORT'] ?? ($block['UF_SORT'] ?? 100);
$activeValue = $_POST['ACTIVE'] ?? (($block && !empty($block['UF_ACTIVE'])) ? 'Y' : 'Y');
if ($block && empty($_POST) && !$block['UF_ACTIVE']) {
    $activeValue = 'N';
}

$textHtmlValue = $_POST['TEXT_HTML'] ?? (string)($settings['html'] ?? '');
$iframeUrlValue = $_POST['IFRAME_URL'] ?? (string)($settings['url'] ?? '');
$iframeHeightValue = (int)($_POST['IFRAME_HEIGHT'] ?? (int)($settings['height'] ?? 600));

$linkUrlValue = $_POST['LINK_URL'] ?? (string)($settings['url'] ?? '');
$linkLabelValue = $_POST['LINK_LABEL'] ?? (string)($settings['label'] ?? 'Открыть');

$APPLICATION->SetTitle($blockId > 0 ? "Редактирование блока" : "Создание блока");
?>

<h1><?= ($blockId > 0 ? 'Редактирование' : 'Создание') ?> блока</h1>

<p>
    <a href="/local/typical_sites/blocks.php?code=<?= urlencode($code) ?>&page_id=<?= (int)$page['ID'] ?>">← Назад к блокам</a>
    &nbsp;|&nbsp;
    <a href="/local/typical_sites/site.php?code=<?= urlencode($code) ?>&page=<?= urlencode((string)$page['UF_SLUG']) ?>" target="_blank">Открыть страницу</a>
</p>

<?php if (!empty($errors)): ?>
    <div style="color:red; margin:10px 0;">
        <?php foreach ($errors as $e): ?>
            <div><?= htmlspecialcharsbx($e) ?></div>
        <?php endforeach; ?>
    </div>
<?php endif; ?>

<form method="post" id="ts-block-form">
    <?= bitrix_sessid_post() ?>

    <div style="margin-top:10px;">
        <label>TYPE:</label><br>
        <select name="TYPE">
            <option value="TEXT" <?= ($typeValue === 'TEXT' ? 'selected' : '') ?>>TEXT</option>
            <option value="IFRAME" <?= ($typeValue === 'IFRAME' ? 'selected' : '') ?>>IFRAME</option>
            <option value="LINK" <?= ($typeValue === 'LINK' ? 'selected' : '') ?>>LINK</option>
        </select>
    </div>

    <div style="margin-top:10px;">
        <label>Заголовок блока:</label><br>
        <input type="text" name="TITLE" value="<?= htmlspecialcharsbx($titleValue) ?>" style="width: 480px;">
    </div>

    <div style="margin-top:10px;">
        <label>Сортировка:</label><br>
        <input type="number" name="SORT" value="<?= (int)$sortValue ?>" style="width: 120px;">
    </div>

    <div style="margin-top:10px;">
        <label>Активен:</label>
        <select name="ACTIVE">
            <option value="Y" <?= ($activeValue === 'Y' ? 'selected' : '') ?>>Y</option>
            <option value="N" <?= ($activeValue === 'N' ? 'selected' : '') ?>>N</option>
        </select>
    </div>

    <hr>

    <div style="margin-top:10px;">
        <h3>Настройки TEXT</h3>
        <?php
        if (Loader::includeModule('fileman') && class_exists('\CFileMan')) {
            \CFileMan::AddHTMLEditorFrame(
                "TEXT_HTML",
                $textHtmlValue,
                "TEXT_HTML_TYPE",
                "html",
                ["height" => 260, "width" => "100%"],
                "N"
            );
        } else {
            ?>
            <textarea name="TEXT_HTML" style="width:100%; height:260px;"><?= htmlspecialcharsbx($textHtmlValue) ?></textarea>
            <?php
        }
        ?>
    </div>

    <div style="margin-top:15px;">
        <h3>Настройки IFRAME</h3>
        <div>
            <label>URL:</label><br>
            <input type="text" name="IFRAME_URL" value="<?= htmlspecialcharsbx($iframeUrlValue) ?>" style="width: 100%;">
        </div>
        <div style="margin-top:8px;">
            <label>Высота (px):</label><br>
            <input type="number" name="IFRAME_HEIGHT" value="<?= (int)$iframeHeightValue ?>" style="width: 120px;">
        </div>
    </div>

    <div style="margin-top:15px;">
        <h3>Настройки LINK</h3>
        <div>
            <label>URL:</label><br>
            <input type="text" name="LINK_URL" value="<?= htmlspecialcharsbx($linkUrlValue) ?>" style="width: 100%;">
        </div>
        <div style="margin-top:8px;">
            <label>Текст кнопки:</label><br>
            <input type="text" name="LINK_LABEL" value="<?= htmlspecialcharsbx($linkLabelValue) ?>" style="width: 320px;">
        </div>
    </div>

    <div style="margin-top:15px;">
        <button type="submit"><?= ($blockId > 0 ? 'Сохранить' : 'Создать') ?></button>
    </div>
</form>

<?php
require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/footer.php");
