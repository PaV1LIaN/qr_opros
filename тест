<?php
require($_SERVER["DOCUMENT_ROOT"]."/bitrix/header.php");

use Bitrix\Main\Context;

require_once $_SERVER["DOCUMENT_ROOT"] . "/local/typical_sites/lib/SiteService.php";

global $USER;
$request = Context::getCurrent()->getRequest();

$code = trim((string)$request->getQuery('code'));
if ($code === '') {
    ShowError("Не указан code");
    require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");
    exit;
}

if (!$USER->IsAuthorized()) {
    ShowError("Требуется авторизация");
    require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");
    exit;
}

$service = new \Cc10\SiteService();
$site = $service->getSiteByCode($code);
if (!$site) {
    ShowError("Сайт не найден или не активен");
    require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");
    exit;
}

$siteId = (int)$site['ID'];
$role = $service->getUserRole((int)$USER->GetID(), $siteId);

if (!$USER->IsAdmin() && !in_array($role, ['ADMIN','DEVELOPER'], true)) {
    ShowError("Нет прав на просмотр логов");
    require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");
    exit;
}

$APPLICATION->SetTitle("Логи: " . (string)$site['UF_NAME']);

$page = max(1, (int)$request->getQuery('p'));
$limit = 50;
$offset = ($page - 1) * $limit;

$total = $service->getAuditCountForSite($siteId);
$rows = $service->getAuditForSite($siteId, $limit, $offset);

$totalPages = max(1, (int)ceil($total / $limit));
?>

<h1>Логи: <?= htmlspecialcharsbx((string)$site['UF_NAME']) ?></h1>

<p>
    <a href="/local/typical_sites/site.php?code=<?= urlencode($code) ?>">← Назад к сайту</a>
</p>

<p>Всего записей: <?= (int)$total ?></p>

<?php if (empty($rows)): ?>
    <p>Логов пока нет.</p>
<?php else: ?>
    <table border="1" cellpadding="6" cellspacing="0" style="width:100%;">
        <tr>
            <th>ID</th>
            <th>Когда</th>
            <th>User</th>
            <th>Action</th>
            <th>Entity</th>
            <th>Entity ID</th>
            <th>Data</th>
        </tr>

        <?php foreach ($rows as $r): ?>
            <?php
            $data = (string)($r['UF_DATA'] ?? '');
            $dataShort = $data;
            if (mb_strlen($dataShort) > 300) {
                $dataShort = mb_substr($dataShort, 0, 300) . '...';
            }
            ?>
            <tr>
                <td><?= (int)$r['ID'] ?></td>
                <td><?= htmlspecialcharsbx((string)$r['UF_CREATED_AT']) ?></td>
                <td><?= (int)$r['UF_USER'] ?></td>
                <td><?= htmlspecialcharsbx((string)$r['UF_ACTION']) ?></td>
                <td><?= htmlspecialcharsbx((string)$r['UF_ENTITY']) ?></td>
                <td><?= (int)$r['UF_ENTITY_ID'] ?></td>
                <td>
                    <pre style="white-space:pre-wrap; margin:0;"><?= htmlspecialcharsbx($dataShort) ?></pre>
                </td>
            </tr>
        <?php endforeach; ?>
    </table>

    <?php if ($totalPages > 1): ?>
        <div style="margin-top:12px;">
            <?php for ($i = 1; $i <= $totalPages; $i++): ?>
                <?php
                $url = '/local/typical_sites/audit.php?code=' . urlencode($code) . '&p=' . $i;
                ?>
                <?php if ($i === $page): ?>
                    <strong style="margin-right:8px;"><?= $i ?></strong>
                <?php else: ?>
                    <a style="margin-right:8px;" href="<?= htmlspecialcharsbx($url) ?>"><?= $i ?></a>
                <?php endif; ?>
            <?php endfor; ?>
        </div>
    <?php endif; ?>
<?php endif; ?>

<?php require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php"); ?>
