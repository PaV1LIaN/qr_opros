<?php
/**
 * Плитки всех подсайтов проекта SiteForge.
 * Видят все авторизованные пользователи.
 * У кого нет доступа — карточка "серая" и без ссылки.
 */

if (!defined("B_PROLOG_INCLUDED") || B_PROLOG_INCLUDED !== true) die();

use Bitrix\Main\Loader;

if (!Loader::includeModule('main')) { return; }

require_once $_SERVER['DOCUMENT_ROOT'].'/local/siteforge/lib/SiteFactory.php';

global $USER;
if (!$USER->IsAuthorized()) {
    echo '<div class="ui-alert ui-alert-warning" style="margin:16px 0">Пожалуйста, авторизуйтесь, чтобы видеть доступные сайты.</div>';
    return;
}

$factory = new \Local\Siteforge\SiteFactory();

// Короткий кеш списка сайтов
$cacheTtl = 60;
$cacheId  = 'siteforge_list_v1';
$cacheDir = '/siteforge_list';

$cache = new CPHPCache();
$sites = [];

if ($cache->InitCache($cacheTtl, $cacheId, $cacheDir)) {
    $vars = $cache->GetVars();
    $sites = $vars['SITES'] ?? [];
} else {
    $sites = $factory->listSites();
    if ($cache->StartDataCache()) {
        $cache->EndDataCache(['SITES' => $sites]);
    }
}

?>
<style>
.sf-grid {display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;margin:16px 0;}
.sf-card {border:1px solid #e1e6eb;border-radius:10px;padding:14px;background:#fff;}
.sf-title {font-weight:600;margin-bottom:8px;}
.sf-muted {opacity:0.55;}
.sf-badge {display:inline-block;border:1px solid #dde3ea;border-radius:8px;padding:2px 8px;font-size:12px;margin-left:8px;}
</style>

<div class="sf-grid">
<?php
if (empty($sites)) {
    echo '<div class="sf-card">Пока нет созданных сайтов.</div>';
} else {
    foreach ($sites as $s) {
        $lid = $s['LID'];
        $name = $s['NAME'];
        $dir = $s['DIR']; // например: /local/siteforge/myfolder/

        $hasAccess = $factory->userHasAccessToSite($lid, (int)$USER->GetID());

        $titleHtml = htmlspecialcharsbx($name.' ('.$lid.')');
        $urlHtml   = htmlspecialcharsbx($dir);

        echo '<div class="sf-card'.($hasAccess ? '' : ' sf-muted').'">';
        echo    '<div class="sf-title">'.$titleHtml;
        echo        $hasAccess ? '<span class="sf-badge">Доступ есть</span>' : '<span class="sf-badge">Нет доступа</span>';
        echo    '</div>';
        echo    '<div>';
        if ($hasAccess) {
            echo '<a href="'.$urlHtml.'">Перейти на сайт</a>';
        } else {
            echo '<span title="У вас нет доступа">Перейти на сайт</span>';
        }
        echo    '</div>';
        echo '</div>';
    }
}
?>
</div>
