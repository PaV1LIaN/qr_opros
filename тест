<?php
include "phpqrcode/qrlib.php";

$pdo = new PDO(
    "pgsql:host=192.168.7.101;port=5432;dbname=bx",
    "bx_user",
    "25##PostPassBX",
    [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        PDO::ATTR_EMULATE_PREPARES => false
    ]
);

// Только активные
$blocks = $pdo->query("
    SELECT id_car, name_car, type_car, nom_car
    FROM qr_schema.cars
    WHERE is_activate = 1
    ORDER BY id_car ASC
")->fetchAll();

$dir = __DIR__ . "/src/images/";
$webDir = "/local/qr_opros/src/images/";

if (!is_dir($dir)) {
    mkdir($dir, 0777, true);
}

foreach ($blocks as $block) {

    $id   = (int)$block['id_car'];
    $name = htmlspecialchars($block['name_car'], ENT_QUOTES, 'UTF-8');
    $type = htmlspecialchars($block['type_car'], ENT_QUOTES, 'UTF-8');
    $nom  = htmlspecialchars($block['nom_car'],  ENT_QUOTES, 'UTF-8');

    // Генерация QR (если файла нет)
    $qrLink   = "https://portal24.itsnn.ru/local/qr_opros/qr_feedback/survey/?car_id=" . $id;
    $filename = $dir . $id . ".png";

    if (!file_exists($filename)) {
        QRcode::png($qrLink, $filename, 'H', 5, 2);
    }

    $qrSrc = $webDir . $id . ".png";

    echo '
    <div class="col-12 col-md-6 col-lg-4">
        <div class="card car-card h-100" data-id="'.$id.'">
            <div class="card-body d-flex flex-column">

                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="car-info">
                        <div class="car-id text-muted mb-1">ID '.$id.'</div>
                        <div class="car-name">'.$name.'</div>
                        <div class="car-type">'.$type.'</div>
                        <div class="car-nom">'.$nom.'</div>
                    </div>

                    <div class="qr-wrapper">
                        <div class="qr-preview">
                            <img src="'.$qrSrc.'" alt="QR код" class="qr-code-right img-fluid">
                        </div>
                    </div>
                </div>

                <div class="mt-auto d-flex flex-wrap gap-2">
                    <a href="/local/qr_opros/qr_feedback/survey/?car_id='.$id.'"
                       class="btn btn-success btn-sm">
                        Оформить
                    </a>

                    <button class="edit-btn btn btn-outline-light btn-sm">
                        Редактировать
                    </button>

                    <button class="remove-btn btn btn-outline-danger btn-sm ms-auto">
                        Деактивировать
                    </button>
                </div>

            </div>
        </div>
    </div>';
}
