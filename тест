<?php
require($_SERVER["DOCUMENT_ROOT"]."/bitrix/header.php");

use Bitrix\Main\Context;

require_once $_SERVER["DOCUMENT_ROOT"] . "/local/typical_sites/lib/SiteService.php";

global $USER;

$request = Context::getCurrent()->getRequest();
$code = trim((string)$request->getQuery('code'));

if ($code === '') {
    ShowError("Не указан code");
    require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");
    exit;
}

if (!$USER->IsAuthorized()) {
    ShowError("Требуется авторизация");
    require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");
    exit;
}

$service = new \Cc10\SiteService();
$site = $service->getSiteByCode($code);

if (!$site) {
    ShowError("Сайт не найден или не активен");
    require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");
    exit;
}

$role = $service->getUserRole((int)$USER->GetID(), (int)$site['ID']);
if (!in_array($role, ['ADMIN','DEVELOPER'], true) && !$USER->IsAdmin()) {
    ShowError("Нет прав на редактирование страниц");
    require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");
    exit;
}

// Убедимся, что есть дефолтные страницы
$service->ensureDefaultPages((int)$site['ID']);

// POST: удалить страницу
if ($request->isPost() && check_bitrix_sessid()) {
    $action = (string)$request->getPost('action');
    $pageId = (int)$request->getPost('page_id');

    try {
        if ($action === 'delete') {
            $service->deletePage($pageId, (int)$site['ID']);
        }
        LocalRedirect('/local/typical_sites/pages.php?code=' . urlencode($code));
    } catch (\Throwable $e) {
        echo '<div style="color:red;">' . htmlspecialcharsbx($e->getMessage()) . '</div>';
    }
}

$pages = $service->getPagesForSite((int)$site['ID'], false);

$APPLICATION->SetTitle("Страницы сайта: " . (string)$site['UF_NAME']);
?>

<h1>Страницы: <?= htmlspecialcharsbx((string)$site['UF_NAME']) ?></h1>

<p>
    <a href="/local/typical_sites/page_edit.php?code=<?= urlencode($code) ?>">+ Добавить страницу</a>
    &nbsp;|&nbsp;
    <a href="/local/typical_sites/site.php?code=<?= urlencode($code) ?>" target="_blank">Открыть сайт</a>
</p>

<?php if (empty($pages)): ?>
    <p>Страниц пока нет.</p>
<?php else: ?>
    <table border="1" cellpadding="6" cellspacing="0">
        <tr>
            <th>ID</th>
            <th>SLUG</th>
            <th>Заголовок</th>
            <th>Сортировка</th>
            <th>Активна</th>
            <th>Действия</th>
        </tr>

        <?php foreach ($pages as $p): ?>
            <tr>
                <td><?= (int)$p['ID'] ?></td>
                <td><?= htmlspecialcharsbx((string)$p['UF_SLUG']) ?></td>
                <td><?= htmlspecialcharsbx((string)$p['UF_TITLE']) ?></td>
                <td><?= (int)$p['UF_SORT'] ?></td>
                <td><?= ($p['UF_ACTIVE'] ? 'Y' : 'N') ?></td>
                <td>
                    <a href="/local/typical_sites/page_edit.php?code=<?= urlencode($code) ?>&page_id=<?= (int)$p['ID'] ?>">Редактировать</a>
                    |
                    <a href="/local/typical_sites/site.php?code=<?= urlencode($code) ?>&page=<?= urlencode((string)$p['UF_SLUG']) ?>" target="_blank">Открыть</a>
                    |
                    <form method="post" style="display:inline;" onsubmit="return confirm('Удалить страницу?');">
                        <?= bitrix_sessid_post() ?>
                        <input type="hidden" name="action" value="delete">
                        <input type="hidden" name="page_id" value="<?= (int)$p['ID'] ?>">
                        <button type="submit">Удалить</button>
                    </form>
                </td>
            </tr>
        <?php endforeach; ?>
    </table>
<?php endif; ?>

<?php require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php"); ?>
