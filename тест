$canManageDevelopers = ($USER->IsAdmin() || $role === 'DEVELOPER');

if ($request->isPost() && check_bitrix_sessid()) {
    $viewers = array_unique(array_filter(array_map('intval', (array)$request->getPost('VIEWERS'))));
    $admins  = array_unique(array_filter(array_map('intval', (array)$request->getPost('ADMINS'))));
    $devsReq = array_unique(array_filter(array_map('intval', (array)$request->getPost('DEVELOPERS'))));

    // Текущие dev'ы из базы
    $access = $service->getAccessForSite($siteId);
    $devsCurrent = [];
    foreach ($access as $row) {
        if (($row['UF_ROLE'] ?? '') === 'DEVELOPER') {
            $devsCurrent[] = (int)$row['UF_USER'];
        }
    }
    $devsCurrent = array_values(array_unique($devsCurrent));

    // ADMIN не имеет права менять DEVELOPERS — сохраняем как было
    $devs = $canManageDevelopers ? $devsReq : $devsCurrent;

    // Защита: нельзя оставить сайт без DEVELOPER
    if (count($devs) === 0) {
        $errors[] = "Нельзя убрать последнего DEVELOPER. У сайта должен быть хотя бы один DEVELOPER.";
    }

    // Защита: нельзя потерять себе управление
    $me = (int)$USER->GetID();

    if (!$USER->IsAdmin()) {
        // если ты DEVELOPER — должен оставаться DEVELOPER или ADMIN
        if ($role === 'DEVELOPER') {
            if (!in_array($me, $devs, true) && !in_array($me, $admins, true)) {
                $errors[] = "Нельзя убрать себе DEVELOPER/ADMIN на этом сайте";
            }
        }
        // если ты ADMIN — должен оставаться ADMIN
        if ($role === 'ADMIN') {
            if (!in_array($me, $admins, true)) {
                $errors[] = "Нельзя убрать себе ADMIN на этом сайте";
            }
        }
    }

    // Если ADMIN попытался подменить devs через POST — просто игнорируем
    // (мы уже сделали $devs = $devsCurrent), можно ещё и сообщение показать при желании.

    if (empty($errors)) {
        try {
            $service->setSiteAccess($siteId, $viewers, $admins, $devs);
            LocalRedirect('/local/typical_sites/site.php?code=' . urlencode($code));
        } catch (\Throwable $e) {
            $errors[] = $e->getMessage();
        }
    }
}
