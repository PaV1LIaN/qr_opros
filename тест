<?php
if (!defined("B_PROLOG_INCLUDED") || B_PROLOG_INCLUDED!==true) die();
use Bitrix\Main\UI\Extension;
Extension::load(['ui.entity-selector','ui.forms','ui.buttons']);
?>
<form method="post">
    <?=bitrix_sessid_post()?>
    <input type="hidden" name="create_site" value="Y">

    <table class="adm-detail-content-table edit-table" style="width:60%;">
        <tr>
            <td class="adm-detail-content-cell-l" width="40%">Название сайта:</td>
            <td class="adm-detail-content-cell-r"><input type="text" name="site_title" size="40" required></td>
        </tr>
        <tr>
            <td>Код сайта (папка):</td>
            <td><input type="text" name="site_code" size="40" required></td>
        </tr>
        <tr>
            <td>Название роли:</td>
            <td><input type="text" name="role_name" size="40" required></td>
        </tr>
        <tr>
            <td>Администраторы сайта:</td>
            <td>
                <input type="hidden" name="role_users" id="role_users_input" value="">
                <div id="role_users_selector"></div>
            </td>
        </tr>
        <tr>
            <td>Обычные пользователи:</td>
            <td>
                <input type="hidden" name="site_users" id="site_users_input" value="">
                <div id="site_users_selector"></div>
            </td>
        </tr>
        <tr>
            <td></td>
            <td><button type="submit" class="ui-btn ui-btn-primary">Создать сайт</button></td>
        </tr>
    </table>
</form>

<script>
BX.ready(function() {
    const dAdmin = new BX.UI.EntitySelector.Dialog({
        id:'portal_admins_create', context:'PORTAL_CREATE',
        targetNode:document.getElementById('role_users_selector'),
        entities:[{id:'user'}], multiple:true, enableSearch:true,
        events:{'Item:onSelect':updAdmins,'Item:onDeselect':updAdmins}
    });
    const dUsers = new BX.UI.EntitySelector.Dialog({
        id:'portal_users_create', context:'PORTAL_CREATE',
        targetNode:document.getElementById('site_users_selector'),
        entities:[{id:'user'}], multiple:true, enableSearch:true,
        events:{'Item:onSelect':updUsers,'Item:onDeselect':updUsers}
    });
    function updAdmins(){
        document.getElementById('role_users_input').value = dAdmin.getSelectedItems().map(i=>i.id).join(',');
    }
    function updUsers(){
        document.getElementById('site_users_input').value = dUsers.getSelectedItems().map(i=>i.id).join(',');
    }
    dAdmin.renderTo(document.getElementById('role_users_selector'));
    dUsers.renderTo(document.getElementById('site_users_selector'));
});
</script>
