use Bitrix\Disk\Folder;
use Bitrix\Disk\Security\SecurityContext;
use Bitrix\Disk\Driver;

public function renameDiskFolder(int $siteRootId, int $folderId, string $newName): void
{
    if (!Loader::includeModule('disk')) throw new \Exception('Модуль disk не установлен');

    $newName = trim($newName);
    if ($newName === '') throw new \Exception('Пустое имя');

    $root = Folder::loadById($siteRootId);
    $folder = Folder::loadById($folderId);
    if (!$root || !$folder) throw new \Exception('Папка не найдена');

    // проверка принадлежности корню
    if (!$this->diskFolderBelongsToRoot($folder, $siteRootId)) {
        throw new \Exception('Папка не принадлежит сайту');
    }

    $ok = $folder->rename($newName, $this->getDiskRightsForUser());
    if (!$ok) throw new \Exception('Не удалось переименовать папку');
}

public function deleteDiskFolder(int $siteRootId, int $folderId): void
{
    if (!Loader::includeModule('disk')) throw new \Exception('Модуль disk не установлен');

    $root = Folder::loadById($siteRootId);
    $folder = Folder::loadById($folderId);
    if (!$root || !$folder) throw new \Exception('Папка не найдена');

    if ((int)$folder->getId() === (int)$siteRootId) {
        throw new \Exception('Нельзя удалить корневую папку сайта');
    }

    if (!$this->diskFolderBelongsToRoot($folder, $siteRootId)) {
        throw new \Exception('Папка не принадлежит сайту');
    }

    $ok = $folder->delete($this->getDiskRightsForUser());
    if (!$ok) throw new \Exception('Не удалось удалить папку');
}

// helpers
protected function diskFolderBelongsToRoot(\Bitrix\Disk\Folder $folder, int $rootId): bool
{
    $cursor = $folder;
    $guard = 0;
    while ($cursor && $guard < 200) {
        $guard++;
        if ((int)$cursor->getId() === $rootId) return true;
        $cursor = $cursor->getParent();
    }
    return false;
}

protected function getDiskRightsForUser(): array
{
    // Bitrix Disk API ждёт массив прав, а не userId.
    // В большинстве коробок ок передать пустой массив (права возьмёт из контекста),
    // но надёжнее использовать SecurityContext.
    $userId = (int)$GLOBALS['USER']->GetID();
    $ctx = new SecurityContext($userId);
    return $ctx->getRights();
}
