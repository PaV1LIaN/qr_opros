<?php
require_once($_SERVER['DOCUMENT_ROOT'].'/bitrix/header.php');
require_once $_SERVER['DOCUMENT_ROOT'].'/local/php_interface/lib/lab_groups.php';
require_once $_SERVER['DOCUMENT_ROOT'].'/local/php_interface/lib/lab_acl.php';

lab_require_any_role(['admin','manager']);

$APPLICATION->SetTitle("Добавить блок");

use Bitrix\Main\Loader;

global $USER;

Loader::includeModule('iblock');

$iblockId = 35;
$errors = [];

if ($_SERVER['REQUEST_METHOD'] === 'POST' && check_bitrix_sessid()) {
    $name        = trim((string)($_POST['NAME'] ?? ''));
    $description = trim((string)($_POST['DESCRIPTION'] ?? ''));

    if ($name === '') {
        $errors[] = "Введите название блока.";
    }

    if (empty($errors)) {
        $bs = new CIBlockSection;

        $code = CUtil::translit($name, "ru", [
            "replace_space" => "-",
            "replace_other" => "-",
            "change_case"   => "L",
            "delete_repeat_replace" => true,
        ]);

        $arFields = [
            "ACTIVE"            => "Y",
            "IBLOCK_ID"         => $iblockId,
            "IBLOCK_SECTION_ID" => false,   // верхний уровень
            "NAME"              => $name,
            "CODE"              => $code,
            "SORT"              => 500,
            "DESCRIPTION"       => $description,
            "DESCRIPTION_TYPE"  => "text",
        ];

        $newId = (int)$bs->Add($arFields);

        if ($newId > 0) {

            // Группа менеджеров конкретного предприятия
            $groupName = "Менеджер " . $name;

            // STRING_ID стабильный и уникальный
            $stringId = "lab_mgr_ent_" . (int)$newId;

            try {
                $managerGroupId = lab_group_create_if_not_exists(
                    $groupName,
                    $stringId,
                    "Менеджеры предприятия: " . $name
                );

                // Записываем ID группы в UF раздела предприятия (нужно UF_MANAGER_GROUP_ID)
                $bs->Update((int)$newId, [
                    "UF_MANAGER_GROUP_ID" => (int)$managerGroupId,
                ]);

            } catch (Throwable $e) {
                // Можно удалить раздел, если не хотим "полу-созданного"
                // CIBlockSection::Delete((int)$newId);
                $errors[] = "Предприятие создано, но не удалось создать группу менеджеров: " . $e->getMessage();
            }

            if (empty($errors)) {
                LocalRedirect("/local/glab/index.php?block_added=Y");
            }

        } else {
            $errors[] = "Ошибка при добавлении: " . $bs->LAST_ERROR;
        }
    }
}
?>

<div class="form-container">
    <h2>Добавить блок (раздел верхнего уровня)</h2>

    <?php if (!empty($errors)): ?>
        <div class="errors">
            <?php foreach ($errors as $e): ?>
                <p style="color:red;"><?= htmlspecialcharsbx($e) ?></p>
            <?php endforeach; ?>
        </div>
    <?php endif; ?>

    <form method="post">
        <?= bitrix_sessid_post() ?>

        <div class="field">
            <label>Название блока</label><br>
            <input type="text" name="NAME"
                   value="<?= htmlspecialcharsbx($_POST['NAME'] ?? '') ?>"
                   style="width:100%;">
        </div>

        <div class="field">
            <label>Описание</label><br>
            <textarea name="DESCRIPTION" style="width:100%; height:120px;"><?= htmlspecialcharsbx($_POST['DESCRIPTION'] ?? '') ?></textarea>
        </div>

        <div class="field">
            <button type="submit">Добавить</button>
            <a href="/local/glab/index.php">Отмена</a>
        </div>
    </form>
</div>

<?php require_once($_SERVER['DOCUMENT_ROOT'].'/bitrix/footer.php'); ?>
