<?php
require($_SERVER["DOCUMENT_ROOT"]."/bitrix/header.php");
$APPLICATION->SetTitle("Доступы к сайту");

global $USER;
if (!$USER->IsAdmin()) {
    ShowError("Доступ запрещён");
    require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");
    exit;
}

\Bitrix\Main\UI\Extension::load("ui.entity-selector");

require_once $_SERVER["DOCUMENT_ROOT"] . "/local/typical_sites/lib/SiteService.php";
$service = new \Cc10\SiteService();

$request = \Bitrix\Main\Context::getCurrent()->getRequest();
$siteId = (int)$request->getQuery('site_id');
if ($siteId <= 0) {
    ShowError("Не указан site_id");
    require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");
    exit;
}

$site = $service->getSiteById($siteId);
if (!$site) {
    ShowError("Сайт не найден");
    require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");
    exit;
}

$errors = [];
if ($request->isPost() && check_bitrix_sessid()) {
    // получаем массивы VIEWERS[] / ADMINS[]
    $viewers = array_unique(array_filter(array_map('intval', (array)$request->getPost('VIEWERS'))));
    $admins  = array_unique(array_filter(array_map('intval', (array)$request->getPost('ADMINS'))));

    try {
        $service->setSiteAccess($siteId, $viewers, $admins);
        LocalRedirect('/local/typical_sites/admin.php');
    } catch (\Throwable $e) {
        $errors[] = $e->getMessage();
    }
}

// текущие права
$access = $service->getAccessForSite($siteId);
$viewersInit = [];
$adminsInit = [];

foreach ($access as $row) {
    if ($row['UF_ROLE'] === 'VIEWER') $viewersInit[] = (int)$row['UF_USER'];
    if ($row['UF_ROLE'] === 'ADMIN')  $adminsInit[]  = (int)$row['UF_USER'];
}
?>

<h1>Доступы: <?= htmlspecialcharsbx($site['UF_NAME']) ?> (ID <?= (int)$siteId ?>)</h1>

<?php if (!empty($errors)): ?>
    <div style="color:red;">
        <?php foreach ($errors as $e): ?>
            <div><?= htmlspecialcharsbx($e) ?></div>
        <?php endforeach; ?>
    </div>
<?php endif; ?>

<form method="post" id="ts-access-form">
    <?= bitrix_sessid_post() ?>

    <div style="margin-top:10px;">
        <label>VIEWERS:</label><br>
        <div id="ts-viewers"></div>
        <div id="ts-viewers-inputs"></div>
    </div>

    <div style="margin-top:10px;">
        <label>ADMINS:</label><br>
        <div id="ts-admins"></div>
        <div id="ts-admins-inputs"></div>
    </div>

    <div style="margin-top:15px;">
        <button type="submit">Сохранить доступы</button>
        <a href="/local/typical_sites/admin.php" style="margin-left:10px;">Назад</a>
    </div>
</form>

<script>
BX.ready(function () {
  function renderHidden(selector, inputsId, name) {
    const box = document.getElementById(inputsId);
    box.innerHTML = "";
    selector.getTags().forEach(tag => {
      if (tag.getEntityId && tag.getEntityId() === "user") {
        const id = parseInt(tag.getId(), 10);
        if (!id) return;
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = name + "[]";
        input.value = id;
        box.appendChild(input);
      }
    });
  }

  function make(renderId, inputsId, name, context, initIds) {
    const selector = new BX.UI.EntitySelector.TagSelector({
      id: renderId,
      multiple: true,
      dialogOptions: {
        context: context,
        entities: [{ id: "user" }],
        multiple: true,
        enableSearch: true
      },
      events: {
        onAfterTagAdd: () => renderHidden(selector, inputsId, name),
        onAfterTagRemove: () => renderHidden(selector, inputsId, name),
      }
    });

    selector.renderTo(document.getElementById(renderId));

    // preselect
    (initIds || []).forEach(id => {
      selector.addTag({
        id: String(id),
        entityId: "user",
        title: "user#" + id
      });
    });

    renderHidden(selector, inputsId, name);
    return selector;
  }

  const viewersInit = <?= json_encode($viewersInit) ?>;
  const adminsInit  = <?= json_encode($adminsInit) ?>;

  const viewersSel = make("ts-viewers", "ts-viewers-inputs", "VIEWERS", "TYPICAL_SITES_VIEWERS_EDIT", viewersInit);
  const adminsSel  = make("ts-admins",  "ts-admins-inputs",  "ADMINS",  "TYPICAL_SITES_ADMINS_EDIT", adminsInit);

  document.getElementById("ts-access-form").addEventListener("submit", function () {
    renderHidden(viewersSel, "ts-viewers-inputs", "VIEWERS");
    renderHidden(adminsSel,  "ts-admins-inputs",  "ADMINS");
  });
});
</script>

<?php
require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");
