<?php
if (!defined("B_PROLOG_INCLUDED") || B_PROLOG_INCLUDED !== true) die();
global $USER;

use Bitrix\Main\UI\Extension;

Extension::load(['ui.entity-selector', 'ui.buttons', 'ui.alerts', 'main.core']);
?>

<style>
.portal-card {
    background: #fff;
    border: 1px solid #e3e7ec;
    border-radius: 12px;
    padding: 18px;
    margin-bottom: 16px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    transition: all 0.2s ease;
}
.portal-card:hover {
    box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    border-color: #dce2eb;
}
.portal-card h4 {
    margin: 0;
    font-size: 17px;
    font-weight: 600;
}
.portal-meta {
    color: #9ea5b4;
    font-size: 13px;
    margin-top: 4px;
}
.portal-users {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
}
.portal-list-link {
    text-decoration: none;
    color: #0065ff;
    display: block;
    padding: 12px 16px;
    background: #fff;
    border-radius: 8px;
    margin-bottom: 8px;
    transition: background 0.2s;
}
.portal-list-link:hover {
    background: #f5f7fa;
}
</style>

<div style="margin:24px 0;">
    <h3 style="margin:0 0 16px; font-size:20px; font-weight:600;">Доступные сайты</h3>

    <?php if (empty($sites)): ?>
        <div class="ui-alert ui-alert-warning">
            <span class="ui-alert-message">Нет доступных сайтов.</span>
        </div>
    <?php else: ?>

        <?php if (!$USER->IsAdmin()): ?>
            <!-- ======= ВИД ДЛЯ ОБЫЧНОГО ПОЛЬЗОВАТЕЛЯ ======= -->
            <?php foreach ($sites as $site): ?>
                <?php
                $siteName = htmlspecialcharsbx($site["NAME"]);
                $siteCode = htmlspecialcharsbx($site["CODE"]);
                ?>
                <a href="/local/portal_hub/sites/<?= $siteCode ?>/" class="portal-list-link">
                    <?= $siteName ?>
                </a>
            <?php endforeach; ?>

        <?php else: ?>
            <!-- ======= ВИД ДЛЯ АДМИНИСТРАТОРОВ ======= -->
            <?php foreach ($sites as $site): ?>
                <?php
                $siteId   = (int)$site["ID"];
                $siteName = htmlspecialcharsbx($site["NAME"]);
                $siteCode = htmlspecialcharsbx($site["CODE"]);
                $roleId   = (int)($site["PROPERTY_SITE_ROLE_VALUE"] ?? 0);

                // Текущие участники роли
                $members = [];
                if ($roleId > 0) {
                    $by = "id"; $order = "asc";
                    $rs = CUser::GetList($by, $order, ["GROUPS_ID" => [$roleId]], ["FIELDS" => ["ID","NAME","LAST_NAME","LOGIN","PERSONAL_PHOTO"]]);
                    while ($u = $rs->Fetch()) {
                        $name = trim($u["NAME"] . " " . $u["LAST_NAME"]);
                        if ($name === "") { $name = $u["LOGIN"]; }

                        // Мини-аватар
                        $photo = "";
                        if (!empty($u["PERSONAL_PHOTO"])) {
                            $file = CFile::ResizeImageGet(
                                $u["PERSONAL_PHOTO"],
                                ["width" => 32, "height" => 32],
                                BX_RESIZE_IMAGE_EXACT,
                                false
                            );
                            if (!empty($file["src"])) {
                                $photo = $file["src"];
                            }
                        }

                        $members[] = [
                            "id" => (int)$u["ID"],
                            "title" => $name,
                            "avatar" => $photo
                        ];
                    }
                }
                ?>
                <div class="portal-card">
                    <h4>
                        <a href="/local/portal_hub/sites/<?= $siteCode ?>/"
                           target="_blank"
                           class="ui-link ui-link-primary">
                           <?= $siteName ?>
                        </a>
                    </h4>
                    <div class="portal-meta">Папка: /local/portal_hub/sites/<?= $siteCode ?>/</div>
                    <?php if ($roleId > 0): ?>
                        <div class="portal-meta">Роль (ID группы): <?= $roleId ?></div>
                    <?php else: ?>
                        <div class="portal-meta">Роль не назначена — сайт виден всем</div>
                    <?php endif; ?>

                    <?php if ($roleId > 0): ?>
                        <div class="portal-users" id="user-selector-<?= $roleId ?>"></div>
                        <script>
                        BX.ready(function() {
                            var ctn = document.getElementById('user-selector-<?= $roleId ?>');
                            if (!ctn) return;

                            var users = <?= \Bitrix\Main\Web\Json::encode($members) ?>;

                            users.forEach(function(u) {
                                var el = document.createElement('div');
                                el.className = 'ui-label ui-label-light ui-label-fill-light';
                                el.style.display = 'flex';
                                el.style.alignItems = 'center';
                                el.style.gap = '6px';
                                el.style.margin = '4px';
                                el.innerHTML =
                                    (u.avatar
                                        ? '<img src="' + BX.util.htmlspecialchars(u.avatar) + '" style="width:24px; height:24px; border-radius:50%; object-fit:cover;">'
                                        : '<div style="width:24px; height:24px; border-radius:50%; background:#e1e5eb; display:flex; align-items:center; justify-content:center; font-size:11px; color:#555;">' + (u.title ? u.title.charAt(0).toUpperCase() : '?') + '</div>'
                                    ) +
                                    '<span class="ui-label-inner">' + BX.util.htmlspecialchars(u.title) + '</span>';
                                ctn.appendChild(el);
                            });
                        });
                        </script>

                        <div style="margin-top:10px;">
                            <button type="button"
                                class="ui-btn ui-btn-light-border ui-btn-sm js-edit-role"
                                data-role-id="<?= $roleId ?>"
                                data-users='<?= htmlspecialcharsbx(json_encode($members, JSON_UNESCAPED_UNICODE)) ?>'>
                                Редактировать участников
                            </button>
                            <div id="save-status-<?= $roleId ?>" style="margin-top:8px;"></div>
                        </div>
                    <?php endif; ?>
                </div>
            <?php endforeach; ?>
        <?php endif; ?>

    <?php endif; ?>
</div>

<?php if ($USER->IsAdmin()): ?>
<script>
BX.ready(function () {
    const BX_SESSID = '<?= bitrix_sessid() ?>';

    function renderUsers(container, users) {
        container.innerHTML = '';
        users.forEach(u => {
            const el = document.createElement('div');
            el.className = 'ui-label ui-label-light ui-label-fill-light';
            el.style.display = 'flex';
            el.style.alignItems = 'center';
            el.style.gap = '6px';
            el.innerHTML =
                (u.avatar
                    ? '<img src="' + BX.util.htmlspecialchars(u.avatar) + '" style="width:24px; height:24px; border-radius:50%; object-fit:cover;">'
                    : '<div style="width:24px; height:24px; border-radius:50%; background:#e1e5eb; display:flex; align-items:center; justify-content:center; font-size:11px; color:#555;">' + (u.title ? u.title.charAt(0).toUpperCase() : '?') + '</div>'
                ) +
                '<span class="ui-label-inner">' + BX.util.htmlspecialchars(u.title) + '</span>';
            container.appendChild(el);
        });
    }

    function saveRole(roleId, userIds, onDone) {
        const fd = new FormData();
        fd.append('AJAX', 'UPDATE_ROLE');
        fd.append('sessid', BX_SESSID);
        fd.append('ROLE_ID', roleId);
        userIds.forEach(id => fd.append('ROLE_USERS[]', id));

        fetch(location.href, { method: 'POST', body: fd, credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => onDone && onDone(data))
            .catch(() => onDone && onDone({ status: 'error' }));
    }

    document.querySelectorAll('.js-edit-role').forEach(btn => {
        btn.addEventListener('click', () => {
            const roleId = btn.dataset.roleId;
            const container = document.getElementById('user-selector-' + roleId);
            const saveStatus = document.getElementById('save-status-' + roleId);
            let currentUsers = [];
            try { currentUsers = JSON.parse(btn.dataset.users) || []; } catch(e) {}

            const dialog = new BX.UI.EntitySelector.Dialog({
                id: 'portal-hub-role-' + roleId,
                context: 'PORTAL_HUB_ROLE_EDIT',
                targetNode: btn,
                entities: [{ id: 'user' }],
                multiple: true,
                enableSearch: true,
                width: 500,
                dropdownMode: false,
                selectedItems: currentUsers.map(u => ({ entityId: 'user', id: String(u.id) })),
                events: {
                    'Item:onSelect': updateView,
                    'Item:onDeselect': updateView
                }
            });

            function updateView() {
                const items = dialog.getSelectedItems();
                renderUsers(container, items.map(i => ({
                    id: i.id,
                    title: i.getTitle(),
                    avatar: i.getAvatar()
                })));
            }

            dialog.subscribe('onHide', () => {
                const items = dialog.getSelectedItems();
                const ids = items.map(i => i.id);
                saveStatus.innerHTML = '<div class="ui-alert ui-alert-primary"><span class="ui-alert-message">Сохраняем...</span></div>';
                saveRole(roleId, ids, data => {
                    if (data.status === 'success') {
                        saveStatus.innerHTML = '<div class="ui-alert ui-alert-success"><span class="ui-alert-message">Изменения сохранены.</span></div>';
                        btn.dataset.users = JSON.stringify(items.map(i => ({
                            id: i.id,
                            title: i.getTitle(),
                            avatar: i.getAvatar()
                        })));
                        setTimeout(() => saveStatus.innerHTML = '', 2500);
                    } else {
                        saveStatus.innerHTML = '<div class="ui-alert ui-alert-danger"><span class="ui-alert-message">Ошибка при сохранении.</span></div>';
                    }
                });
            });

            dialog.show();
        });
    });
});
</script>
<?php endif; ?>
