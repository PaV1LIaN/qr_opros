<h2>Список сайтов</h2>
<ul>
<?php foreach ($sites as $site): ?>
    <li style="margin-bottom: 15px;">
        <a href="/local/portal_hub/sites/<?=$site["CODE"]?>/" target="_blank">
            <?=$site["NAME"]?>
        </a>

        <?php if ($USER->IsAdmin()): ?>
            <!-- показываем текущие доступы -->
            <div style="margin-left:20px;">
                <strong>Доступ:</strong>
                <?php
                $accessLabels = [];

                // Группы
                if (!empty($site["GROUPS"])) {
                    $rsGroups = CGroup::GetList($by="c_sort", $order="asc", ["ID" => implode("|", $site["GROUPS"])]);
                    while ($group = $rsGroups->Fetch()) {
                        $accessLabels[] = "✅ ".$group["NAME"];
                    }
                }

                // Пользователи
                if (!empty($site["USERS"])) {
                    $rsUsers = CUser::GetList($by="id", $order="asc", ["ID" => implode("|", $site["USERS"])]);
                    while ($user = $rsUsers->Fetch()) {
                        $accessLabels[] = "✅ ".$user["NAME"]." ".$user["LAST_NAME"];
                    }
                }

                echo $accessLabels ? implode(", ", $accessLabels) : "Нет ограничений (доступ для всех)";
                ?>
            </div>

            <!-- кнопка показать форму -->
            <button type="button" onclick="document.getElementById('edit-<?=$site["ID"]?>').style.display='block'">
                Изменить доступ
            </button>

            <!-- скрытая форма -->
            <div id="edit-<?=$site["ID"]?>" style="display:none; margin-top:10px;">
                <form method="post">
                    <?=bitrix_sessid_post()?>
                    <input type="hidden" name="UPDATE_SITE_ID" value="<?=$site["ID"]?>">

                    <h4>Группы:</h4>
                    <select name="SITE_GROUPS[]" multiple size="3">
                        <?php
                        $rsGroups = CGroup::GetList($by="c_sort", $order="asc", []);
                        while ($group = $rsGroups->Fetch()):
                            if ($group["ID"] == 1) continue;
                            $selected = in_array($group["ID"], $site["GROUPS"] ?? []) ? "selected" : "";
                        ?>
                            <option value="<?=$group["ID"]?>" <?=$selected?>><?=$group["NAME"]?></option>
                        <?php endwhile; ?>
                    </select>

                    <h4>Пользователи:</h4>
                    <select name="SITE_USERS[]" multiple size="3">
                        <?php
                        $rsUsers = CUser::GetList($by="id", $order="asc", ["ACTIVE" => "Y"]);
                        while ($user = $rsUsers->Fetch()):
                            $selected = in_array($user["ID"], $site["USERS"] ?? []) ? "selected" : "";
                        ?>
                            <option value="<?=$user["ID"]?>" <?=$selected?>><?=$user["NAME"]?> <?=$user["LAST_NAME"]?></option>
                        <?php endwhile; ?>
                    </select>

                    <br><br>
                    <button type="submit">Сохранить</button>
                    <button type="button" onclick="document.getElementById('edit-<?=$site["ID"]?>').style.display='none'">Отмена</button>
                </form>
            </div>
        <?php endif; ?>
    </li>
<?php endforeach; ?>
</ul>
