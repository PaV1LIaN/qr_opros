<script>
BX.ready(function() {
    BX.loadExt('ui.entity-selector').then(() => {

        const adminInput = document.getElementById('role_users_input');
        const userInput  = document.getElementById('site_users_input');

        function normalize(items) {
            return items.map(i => String(i.id).replace(/^user:/,'')).filter(Boolean);
        }
        function update(selector, input) {
            input.value = normalize(selector.getSelectedItems()).join(',');
            console.log('Selected:', input.name, input.value);
        }

        // === Администраторы ===
        const adminSel = new BX.UI.EntitySelector.TagSelector({
            id: 'portal_admins',
            multiple: true,
            textBoxWidth: '100%',
            dialogOptions: {
                id: 'portal_admins_dialog',
                context: 'PORTAL_CREATE',
                multiple: true,
                enableSearch: true,
                entities: [
                    {
                        id: 'user',
                        selectable: true,          // <-- разрешаем выбор
                        options: { intranetUsersOnly: true }
                    }
                ]
            }
        });
        adminSel.renderTo(document.getElementById('admin_tag_selector'));
        adminSel.subscribe('onTagAdd',   () => update(adminSel, adminInput));
        adminSel.subscribe('onTagRemove',() => update(adminSel, adminInput));

        // === Пользователи ===
        const userSel = new BX.UI.EntitySelector.TagSelector({
            id: 'portal_users',
            multiple: true,
            textBoxWidth: '100%',
            dialogOptions: {
                id: 'portal_users_dialog',
                context: 'PORTAL_CREATE',
                multiple: true,
                enableSearch: true,
                entities: [
                    {
                        id: 'user',
                        selectable: true,          // <-- обязательно
                        options: { intranetUsersOnly: true }
                    }
                ]
            }
        });
        userSel.renderTo(document.getElementById('user_tag_selector'));
        userSel.subscribe('onTagAdd',   () => update(userSel, userInput));
        userSel.subscribe('onTagRemove',() => update(userSel, userInput));
    });
});
</script>
