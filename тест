<?php
define('NO_KEEP_STATISTIC', true);
define('NO_AGENT_STATISTIC', true);
define('DisableEventsCheck', true);

require $_SERVER['DOCUMENT_ROOT'].'/bitrix/modules/main/include/prolog_before.php';

global $USER, $APPLICATION;

if (!$USER->IsAuthorized()) {
    LocalRedirect('/auth/');
}

header('Content-Type: text/html; charset=UTF-8');

\Bitrix\Main\UI\Extension::load([
    'main.core',
    'ui.buttons',
    'ui.dialogs.messagebox',
    'ui.notification',
]);
?>
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SiteBuilder</title>

  <?php $APPLICATION->ShowHead(); ?>

  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: Arial, sans-serif; background:#f6f7f8; }
    .wrap { padding: 24px; }
    .box { background:#fff; border: 1px solid #e5e7ea; border-radius: 12px; padding: 16px; }
    table code { background: #f3f4f6; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="box">
      <h1 style="margin-top:0;">SiteBuilder</h1>

      <div>Ты авторизован как: <b><?=htmlspecialcharsbx($USER->GetLogin())?></b></div>
      <div style="margin-top:10px; color:#6a737f;">
        Открыто напрямую: <code>/local/sitebuilder/index.php</code>
      </div>

      <div style="margin-top:14px;">
        <button class="ui-btn ui-btn-primary" id="btnCreateSite">Создать сайт</button>
      </div>

      <div style="margin-top:14px;" id="sitesBox"></div>
    </div>
  </div>

<script>
BX.ready(function () {
  const sitesBox = document.getElementById('sitesBox');
  const btnCreate = document.getElementById('btnCreateSite');

  function api(action, data) {
    return new Promise((resolve, reject) => {
      BX.ajax({
        url: '/local/sitebuilder/api.php',
        method: 'POST',
        dataType: 'json',
        data: Object.assign({ action, sessid: BX.bitrix_sessid() }, data || {}),
        onsuccess: resolve,
        onfailure: reject
      });
    });
  }

  function renderSites(sites) {
    if (!sites || !sites.length) {
      sitesBox.innerHTML = '<div style="color:#6a737f;">Сайтов пока нет. Создай первый.</div>';
      return;
    }

    const rows = sites.map(s => `
      <tr>
        <td style="padding:8px;border-bottom:1px solid #eee;">${s.id}</td>
        <td style="padding:8px;border-bottom:1px solid #eee;">${BX.util.htmlspecialchars(s.name)}</td>
        <td style="padding:8px;border-bottom:1px solid #eee;"><code>${BX.util.htmlspecialchars(s.slug)}</code></td>
        <td style="padding:8px;border-bottom:1px solid #eee;color:#6a737f;">${BX.util.htmlspecialchars(s.createdAt)}</td>
        <td style="padding:8px;border-bottom:1px solid #eee;">
          <button class="ui-btn ui-btn-danger ui-btn-xs" data-delete-site-id="${s.id}">Удалить</button>
        </td>
      </tr>
    `).join('');

    sitesBox.innerHTML = `
      <table style="width:100%; border-collapse:collapse; margin-top:6px;">
        <thead>
          <tr>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">ID</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Название</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Slug</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Создан</th>
            <th style="text-align:left;padding:8px;border-bottom:1px solid #eee;">Действия</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }

  function loadSites() {
    api('site.list').then(res => {
      if (!res || res.ok !== true) {
        BX.UI.Notification.Center.notify({ content: 'Не удалось загрузить список сайтов' });
        return;
      }
      renderSites(res.sites);
    }).catch(() => {
      BX.UI.Notification.Center.notify({ content: 'Ошибка запроса site.list' });
    });
  }

  function openCreateDialog() {
    const formHtml = `
      <div style="display:flex; flex-direction:column; gap:10px;">
        <div>
          <div style="font-size:12px;color:#6a737f;margin-bottom:4px;">Название сайта</div>
          <input type="text" id="sb_name"
            style="width:100%; padding:8px; border:1px solid #d0d7de; border-radius:8px;"
            placeholder="Например: Лаборатория" />
        </div>
        <div>
          <div style="font-size:12px;color:#6a737f;margin-bottom:4px;">Slug (необязательно)</div>
          <input type="text" id="sb_slug"
            style="width:100%; padding:8px; border:1px solid #d0d7de; border-radius:8px;"
            placeholder="lab (если пусто — сделаем автоматически)" />
        </div>
      </div>
    `;

    BX.UI.Dialogs.MessageBox.show({
      title: 'Создать сайт',
      message: formHtml,
      buttons: BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,
      onOk: function (mb) {
        const name = document.getElementById('sb_name')?.value?.trim() || '';
        const slug = document.getElementById('sb_slug')?.value?.trim() || '';

        if (!name) {
          BX.UI.Notification.Center.notify({ content: 'Введите название сайта' });
          return; // не закрываем
        }

        api('site.create', { name, slug }).then(res => {
          if (!res || res.ok !== true) {
            BX.UI.Notification.Center.notify({ content: 'Не удалось создать сайт' });
            return;
          }
          BX.UI.Notification.Center.notify({
            content: `Сайт создан: ${BX.util.htmlspecialchars(res.site.name)} (${BX.util.htmlspecialchars(res.site.slug)})`
          });
          mb.close();
          loadSites();
        }).catch(() => {
          BX.UI.Notification.Center.notify({ content: 'Ошибка запроса site.create' });
        });
      }
    });
  }

  // Делегирование клика по кнопкам "Удалить"
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('[data-delete-site-id]');
    if (!btn) return;

    const id = parseInt(btn.getAttribute('data-delete-site-id'), 10);
    if (!id) return;

    BX.UI.Dialogs.MessageBox.show({
      title: 'Удалить сайт?',
      message: 'Это удалит сайт из списка (пока без страниц и файлов). Продолжить?',
      buttons: BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,
      onOk: function (mb) {
        api('site.delete', { id }).then(res => {
          if (!res || res.ok !== true) {
            BX.UI.Notification.Center.notify({ content: 'Не удалось удалить сайт' });
            return;
          }
          BX.UI.Notification.Center.notify({ content: 'Сайт удалён' });
          mb.close();
          loadSites();
        }).catch(() => {
          BX.UI.Notification.Center.notify({ content: 'Ошибка запроса site.delete' });
        });
      }
    });
  });

  if (btnCreate) {
    btnCreate.addEventListener('click', openCreateDialog);
  }

  loadSites();
});
</script>
</body>
</html>